<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CardamomPulse — Price Intelligence Platform</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg:#f7f7fb; --card:#fff; --ink:#1f2937; --muted:#6b7280; --brand:#0b3d91;
      --grid:#e5e7eb; --accent:#eef2ff; --good:#059669; --warn:#f59e0b; --bad:#dc2626;
      --premium-bg:linear-gradient(135deg,#1e1b4b 0%,#312e81 100%);
      --premium-card:rgba(255,255,255,0.07); --premium-border:rgba(255,255,255,0.12);
      --subscriber-bg:#f0fdf4; --subscriber-border:#bbf7d0;
    }
    *{box-sizing:border-box;}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    .wrap{max-width:1140px;margin:0 auto;padding:24px 20px;}
    h1{font-size:24px;margin:0;color:var(--ink);}
    h2{font-size:18px;margin:0 0 16px;font-weight:700;}
    h3{margin:0 0 10px;font-size:15px;font-weight:600;}
    .muted{color:var(--muted);font-size:13px;}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;margin-bottom:16px;}
    .card{background:var(--card);border:1px solid var(--grid);border-radius:14px;padding:18px;box-shadow:0 1px 3px rgba(0,0,0,.04);}
    .kpi{font-size:28px;font-weight:700;line-height:1.2;}
    .kpi-label{font-size:12px;color:var(--muted);margin-top:2px;text-transform:uppercase;letter-spacing:0.5px;}
    .kpi-sub{font-size:13px;margin-top:4px;}
    table{width:100%;border-collapse:collapse;font-size:13px;}
    th,td{padding:8px 10px;border-bottom:1px solid var(--grid);text-align:right;}
    th:first-child,td:first-child{text-align:left;}
    thead th{background:#f3f4f6;font-weight:600;color:#111827;position:sticky;top:0;}
    .good{color:var(--good);} .bad{color:var(--bad);} .warn{color:var(--warn);}
    .flex{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .pill{border-radius:999px;padding:4px 10px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;display:inline-block;}
    .pill-free{background:#dbeafe;color:#1d4ed8;}
    .pill-sub{background:#d1fae5;color:#065f46;}
    .pill-premium{background:#ede9fe;color:#5b21b6;}
    .regime-badge{display:inline-block;padding:6px 16px;border-radius:999px;font-size:14px;font-weight:700;}
    .regime-low{background:#d1fae5;color:#065f46;}
    .regime-moderate{background:#fef3c7;color:#92400e;}
    .regime-high{background:#fee2e2;color:#991b1b;}
    .status-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;}
    .status-live{background:var(--good);} .status-stale{background:var(--warn);}
    .footer{font-size:12px;color:var(--muted);text-align:center;padding:24px 0 8px;}

    /* Tier sections */
    .tier-section{border-radius:16px;padding:24px;margin-bottom:24px;}
    .tier-header{display:flex;align-items:center;gap:10px;margin-bottom:18px;}
    .tier-free{background:#fff;border:1px solid var(--grid);}
    .tier-subscriber{background:var(--subscriber-bg);border:1px solid var(--subscriber-border);}
    .tier-premium{background:var(--premium-bg);border:none;color:#e0e7ff;}
    .tier-premium h2,.tier-premium h3{color:#e0e7ff;}
    .tier-premium .muted{color:#a5b4fc;}
    .tier-premium .card{background:var(--premium-card);border:1px solid var(--premium-border);color:#e0e7ff;}
    .tier-premium table{color:#e0e7ff;}
    .tier-premium thead th{background:rgba(255,255,255,0.08);color:#c7d2fe;}
    .tier-premium th,.tier-premium td{border-bottom-color:rgba(255,255,255,0.1);}
    .tier-premium .kpi-label{color:#a5b4fc;}
    .tier-premium .good{color:#34d399;} .tier-premium .bad{color:#fca5a5;} .tier-premium .warn{color:#fcd34d;}

    /* Chart container */
    .chart-wrap{position:relative;height:280px;}
    .chart-wrap canvas{width:100%!important;height:100%!important;}

    /* Tab nav for chart periods */
    .tab-nav{display:flex;gap:4px;margin-bottom:12px;}
    .tab-btn{padding:5px 12px;border:1px solid var(--grid);background:#fff;border-radius:8px;font-size:12px;cursor:pointer;font-weight:500;color:var(--muted);}
    .tab-btn.active{background:var(--brand);color:#fff;border-color:var(--brand);}
    .tier-premium .tab-btn{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.15);color:#a5b4fc;}
    .tier-premium .tab-btn.active{background:#4f46e5;color:#fff;border-color:#4f46e5;}

    /* Volume bars */
    .vol-bar{height:6px;border-radius:3px;background:var(--brand);display:inline-block;vertical-align:middle;}
    .tier-premium .vol-bar{background:#818cf8;}

    /* Scrollable table */
    .table-scroll{max-height:320px;overflow-y:auto;border-radius:8px;}

    @media(max-width:768px){
      .row{grid-template-columns:1fr!important;}
      .row>[style*="span"]{grid-column:span 1!important;}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body>
  <div class="wrap">

    <!-- ═══════════════════════════════════════════════════════════════
         HEADER
         ═══════════════════════════════════════════════════════════════ -->
    <header style="margin-bottom:20px;">
      <div class="flex" style="justify-content:space-between;align-items:flex-end;">
        <div>
          <h1>CardamomPulse</h1>
          <div class="muted" style="margin-top:4px;">
            <span class="status-dot" id="status-dot"></span>
            <span id="status-text">Loading pipeline data...</span>
          </div>
        </div>
        <div class="muted" style="text-align:right;">
          Pipeline runs daily at 6:00 PM IST<br>
          Data refreshed automatically
        </div>
      </div>
    </header>

    <!-- ═══════════════════════════════════════════════════════════════
         FREE TIER — Market Overview
         ═══════════════════════════════════════════════════════════════ -->
    <section class="tier-section tier-free">
      <div class="tier-header">
        <h2>Market Overview</h2>
        <span class="pill pill-free">Free</span>
      </div>

      <!-- KPIs -->
      <div class="row">
        <div class="card" style="grid-column:span 3;">
          <div class="kpi" id="kpi-spot">--</div>
          <div class="kpi-label">Spot Price (Avg)</div>
          <div class="kpi-sub" id="kpi-change"></div>
        </div>
        <div class="card" style="grid-column:span 3;">
          <div class="kpi" id="kpi-max">--</div>
          <div class="kpi-label">Max Price</div>
          <div class="kpi-sub muted" id="kpi-date"></div>
        </div>
        <div class="card" style="grid-column:span 3;background:#ecfdf5;border-color:#a7f3d0;">
          <div class="kpi" id="kpi-predicted" style="color:#059669;">--</div>
          <div class="kpi-label">Predicted Price Today</div>
          <div class="kpi-sub muted" id="kpi-predicted-horizon"></div>
        </div>
        <div class="card" style="grid-column:span 3;">
          <div style="text-align:center;padding:8px 0;">
            <div id="regime-badge" class="regime-badge">--</div>
            <div class="muted" style="margin-top:8px;" id="regime-detail"></div>
            <div class="muted" style="margin-top:4px;font-size:12px;" id="regime-change-text"></div>
          </div>
          <div class="kpi-label" style="text-align:center;">Market Regime</div>
        </div>
      </div>

      <!-- 30-day predicted vs actual chart (free) -->
      <div class="card">
        <h3>Predicted vs Actual (Last 30 Days)</h3>
        <div class="chart-wrap">
          <canvas id="chart-free"></canvas>
        </div>
      </div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════
         SUBSCRIBER TIER — Forecasts & Analytics
         ═══════════════════════════════════════════════════════════════ -->
    <section class="tier-section tier-subscriber">
      <div class="tier-header">
        <h2>Forecasts &amp; Analytics</h2>
        <span class="pill pill-sub">Subscriber</span>
      </div>

      <div class="row">
        <!-- Forecasts table -->
        <div class="card" style="grid-column:span 7;">
          <h3>Price Forecasts</h3>
          <table id="forecast-tbl">
            <thead><tr><th>Horizon</th><th>Target Date</th><th>Predicted</th><th>Range (80%)</th><th>Model</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <!-- Accuracy KPIs -->
        <div class="card" style="grid-column:span 5;">
          <h3>Model Accuracy (30-day)</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:8px;">
            <div>
              <div class="kpi" id="kpi-mape" style="font-size:22px;">--%</div>
              <div class="kpi-label">MAPE</div>
            </div>
            <div>
              <div class="kpi" id="kpi-rmse" style="font-size:22px;">--</div>
              <div class="kpi-label">RMSE</div>
            </div>
            <div>
              <div class="kpi" id="kpi-score" style="font-size:22px;">--</div>
              <div class="kpi-label">Avg Score</div>
            </div>
            <div>
              <div class="kpi" id="kpi-hitrate" style="font-size:22px;">--%</div>
              <div class="kpi-label">Hit Rate (&plusmn;5%)</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Full price history chart -->
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;margin-bottom:4px;">
          <h3 style="margin:0;">Price Forecast Graph</h3>
          <div class="tab-nav" id="chart-tabs">
            <button class="tab-btn" data-range="90">3M</button>
            <button class="tab-btn active" data-range="180">6M</button>
            <button class="tab-btn" data-range="365">1Y</button>
            <button class="tab-btn" data-range="0">All</button>
          </div>
        </div>
        <div class="chart-wrap">
          <canvas id="chart-subscriber"></canvas>
        </div>
      </div>

      <!-- Deviation table -->
      <div class="card">
        <h3>Daily Deviation (Last 30 Days)</h3>
        <div class="table-scroll">
          <table id="tbl-deviation">
            <thead>
              <tr><th>Date</th><th>Actual</th><th>Predicted</th><th>Abs. Error</th><th>Pct. Error</th><th>Score</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════
         PREMIUM TIER — Deep Intelligence
         ═══════════════════════════════════════════════════════════════ -->
    <section class="tier-section tier-premium">
      <div class="tier-header">
        <h2>Deep Intelligence</h2>
        <span class="pill pill-premium">Premium</span>
      </div>

      <div class="row">
        <!-- 90-day extended forecast -->
        <div class="card" style="grid-column:span 6;">
          <h3>90-Day Extended Forecast</h3>
          <div style="text-align:center;padding:16px 0;">
            <div class="kpi" id="kpi-90d-price" style="font-size:32px;">--</div>
            <div class="kpi-label">Predicted Price</div>
            <div class="muted" style="margin-top:8px;" id="kpi-90d-range"></div>
            <div class="muted" style="margin-top:4px;" id="kpi-90d-date"></div>
          </div>
          <div class="chart-wrap" style="height:200px;">
            <canvas id="chart-confidence"></canvas>
          </div>
        </div>

        <!-- Volume analysis -->
        <div class="card" style="grid-column:span 6;">
          <h3>Volume Analysis</h3>
          <div class="row" style="margin-bottom:12px;">
            <div style="grid-column:span 6;">
              <div class="kpi" id="kpi-vol-today" style="font-size:20px;">--</div>
              <div class="kpi-label">Latest Volume (kg)</div>
            </div>
            <div style="grid-column:span 6;">
              <div class="kpi" id="kpi-vol-avg" style="font-size:20px;">--</div>
              <div class="kpi-label">30-Day Avg Volume</div>
            </div>
          </div>
          <div class="table-scroll" style="max-height:240px;">
            <table id="tbl-volume">
              <thead><tr><th>Date</th><th>Volume (kg)</th><th>Avg Price</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Full price chart with all overlays -->
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;margin-bottom:4px;">
          <h3 style="margin:0;">Complete Price &amp; Forecast Overlay</h3>
          <div class="tab-nav" id="premium-chart-tabs">
            <button class="tab-btn" data-range="90">3M</button>
            <button class="tab-btn" data-range="180">6M</button>
            <button class="tab-btn active" data-range="365">1Y</button>
            <button class="tab-btn" data-range="0">All</button>
          </div>
        </div>
        <div class="chart-wrap" style="height:320px;">
          <canvas id="chart-premium"></canvas>
        </div>
      </div>

      <!-- Market Insights from Research -->
      <div class="card">
        <h3>Market Intelligence Insights</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
          <div style="padding:12px;border-radius:10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);">
            <div style="font-weight:600;margin-bottom:6px;font-size:13px;">Guatemala Supply Shock</div>
            <div class="muted" style="font-size:12px;line-height:1.6;">Guatemala controls 50-70% of global cardamom exports. The 2024-25 thrips infestation reduced exports 46-75%, making it the primary driver of the current bull run.</div>
          </div>
          <div style="padding:12px;border-radius:10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);">
            <div style="font-weight:600;margin-bottom:6px;font-size:13px;">Cost Floor Creates Asymmetric Risk</div>
            <div class="muted" style="font-size:12px;line-height:1.6;">Kerala agricultural wages rise 5.2% annually, pushing production costs to ~&#8377;580/kg. Current prices at 4.3x cost are unusually profitable, but a crash below &#8377;400/kg triggers farmer abandonment.</div>
          </div>
          <div style="padding:12px;border-radius:10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);">
            <div style="font-weight:600;margin-bottom:6px;font-size:13px;">3-4 Year Planting Cobweb Cycle</div>
            <div class="muted" style="font-size:12px;line-height:1.6;">High prices drive planting surges that take 3 years to mature. The 2019-20 peak triggered the 2021-23 oversupply crash. Current prices may create new supply pressure by 2027-28.</div>
          </div>
          <div style="padding:12px;border-radius:10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);">
            <div style="font-weight:600;margin-bottom:6px;font-size:13px;">La Ni&ntilde;a Drives Prices Higher</div>
            <div class="muted" style="font-size:12px;line-height:1.6;">Counterintuitively, excess rainfall (La Ni&ntilde;a) causes more damage than drought. The 2018 Kerala floods caused a &gt;100% price spike lasting 18+ months, making excess moisture the primary climatic risk.</div>
          </div>
          <div style="padding:12px;border-radius:10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);">
            <div style="font-weight:600;margin-bottom:6px;font-size:13px;">Festival Demand Overrides Supply</div>
            <div class="muted" style="font-size:12px;line-height:1.6;">Prices peak Aug-Dec (&plusmn;10% seasonal swing) during harvest when supply is highest, driven by Diwali, Christmas, and year-end export orders. March-May weakness reflects post-harvest inventory glut.</div>
          </div>
          <div style="padding:12px;border-radius:10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);">
            <div style="font-weight:600;margin-bottom:6px;font-size:13px;">Yield Growth Offsets Cost Inflation</div>
            <div class="muted" style="font-size:12px;line-height:1.6;">Indian cardamom yield surged 153% (2010-2021) via new varieties like IISR Vijetha, creating long-term deflationary pressure despite 5%/year wage growth. Major rallies result from shocks, not structural tightness.</div>
          </div>
        </div>
      </div>

      <!-- Model track record -->
      <div class="card">
        <h3>Model Track Record</h3>
        <div id="track-record-content">
          <p class="muted">Track record builds as forecasts mature and are validated against actuals. Metrics shown per horizon.</p>
          <table id="tbl-track">
            <thead><tr><th>Horizon</th><th>Predictions</th><th>MAPE</th><th>RMSE</th><th>Hit Rate</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════
         DOCUMENTATION
         ═══════════════════════════════════════════════════════════════ -->
    <section class="card" style="margin-bottom:16px;">
      <h3>How It Works</h3>
      <div class="muted" style="line-height:1.7;">
        <p><b>Automated Pipeline:</b> Data is collected daily at 6 PM IST from auction houses and market sources. Models predict 7/14/28/90-day prices. All predictions are stored in an immutable forecast ledger.</p>
        <p><b>Scoring:</b> Daily % error = |predicted - actual| / actual. Deviation score = max(0, 100 &times; (1 - % error)). KPIs include 30-day MAPE, RMSE, and hit-rate within &plusmn;5%.</p>
        <p><b>Market Regime:</b> Bear probability from a Gradient Boosting classifier. LOW (&lt;30%), MODERATE (30-60%), HIGH (&gt;60%).</p>
        <p><b>Tiers:</b> Free users see spot prices and 30-day trends. Subscribers get forecasts, accuracy metrics, and full history. Premium includes extended forecasts, volume analysis, confidence bands, and model track records.</p>
      </div>
    </section>

    <div class="footer">&copy; CardamomPulse — Quantitative intelligence for the cardamom market</div>
  </div>

<script>
  // ── Utilities ──────────────────────────────────────────────────
  const INR = (x) => x == null || x === "" ? "--" : "\u20B9" + Number(x).toLocaleString("en-IN", { maximumFractionDigits: 0 });
  const fmtK = (x) => x == null ? "--" : (x >= 100000 ? (x/1000).toFixed(0) + "k" : Number(x).toLocaleString("en-IN", { maximumFractionDigits: 0 }));
  const parseNum = (x) => (x == null || x === "" ? null : Number(x));
  const $ = (id) => document.getElementById(id);

  // ── State ──────────────────────────────────────────────────────
  let dashboardData = null;
  let priceHistory = [];
  let archive = [];
  let trackRecord = null;
  let chartFree, chartSub, chartPremium, chartConfidence;

  // ── Data loading (all automatic from pipeline) ────────────────
  async function loadAll() {
    const [dashRes, histRes, archRes, trackRes] = await Promise.allSettled([
      fetch("data/dashboard.json").then(r => r.ok ? r.json() : null),
      fetch("data/price_history.json").then(r => r.ok ? r.json() : null),
      fetch("data/archive.csv").then(r => r.ok ? r.text() : null),
      fetch("data/track_record.json").then(r => r.ok ? r.json() : null)
    ]);

    if (dashRes.status === "fulfilled" && dashRes.value) {
      dashboardData = dashRes.value;
      renderHeader(dashboardData);
      renderFreeKPIs(dashboardData);
      renderForecasts(dashboardData);
      renderRegime(dashboardData);
      renderPremiumForecast(dashboardData);
    }

    if (histRes.status === "fulfilled" && histRes.value) {
      priceHistory = histRes.value.prices || [];
      renderFreeChart();
      renderSubscriberChart(180);
      renderVolumeAnalysis();
      renderPremiumChart(365);
    }

    if (archRes.status === "fulfilled" && archRes.value) {
      Papa.parse(archRes.value, {
        header: true, skipEmptyLines: true,
        complete: (res) => {
          archive = res.data;
          renderDeviation();
          renderAccuracyKPIs();
          // Re-render free chart with predicted overlay now that archive is loaded
          if (priceHistory.length) renderFreeChart();
        }
      });
    }

    if (trackRes.status === "fulfilled" && trackRes.value) {
      trackRecord = trackRes.value;
      renderTrackRecord();
    }
  }

  // ── Header / Status ────────────────────────────────────────────
  function renderHeader(data) {
    const dot = $("status-dot");
    const txt = $("status-text");
    const updatedAt = new Date(data.updated_at);
    const ageHours = (Date.now() - updatedAt) / 3600000;
    if (ageHours < 26) {
      dot.className = "status-dot status-live";
      txt.textContent = "Live — updated " + updatedAt.toLocaleDateString("en-IN", {day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});
    } else {
      dot.className = "status-dot status-stale";
      txt.textContent = "Stale — last update " + updatedAt.toLocaleDateString("en-IN", {day:"numeric",month:"short",year:"numeric"});
    }
  }

  // ── FREE: KPIs ─────────────────────────────────────────────────
  function renderFreeKPIs(data) {
    const spot = data.spot_price;
    if (!spot) return;
    $("kpi-spot").textContent = INR(spot.avg_price);
    const changeEl = $("kpi-change");
    const sign = spot.daily_change >= 0 ? "+" : "";
    changeEl.textContent = sign + INR(spot.daily_change) + " (" + sign + spot.daily_change_pct.toFixed(1) + "%)";
    changeEl.className = "kpi-sub " + (spot.daily_change >= 0 ? "good" : "bad");

    $("kpi-max").textContent = INR(spot.max_price);
    $("kpi-date").textContent = spot.date;

    // Predicted price today (nearest horizon forecast)
    const fc = (data.forecasts || [])[0];
    if (fc) {
      $("kpi-predicted").textContent = INR(fc.predicted_price);
      $("kpi-predicted-horizon").textContent = fc.horizon_days + "-day forecast → " + fc.target_date;
    }
  }

  // ── FREE: Regime ───────────────────────────────────────────────
  function renderRegime(data) {
    const regime = data.regime;
    if (!regime) return;
    const badge = $("regime-badge");
    const label = regime.label || "UNKNOWN";
    badge.textContent = label + " RISK";
    badge.className = "regime-badge regime-" + label.toLowerCase();
    $("regime-detail").textContent = (regime.bear_probability * 100).toFixed(0) + "% bear probability";

    // Significant market change indicator
    const changeText = $("regime-change-text");
    const bearPct = regime.bear_probability * 100;
    if (bearPct < 15) {
      changeText.textContent = "No significant market change expected";
      changeText.style.color = "var(--good)";
    } else if (bearPct < 40) {
      changeText.textContent = "Moderate market shift possible";
      changeText.style.color = "var(--warn)";
    } else {
      changeText.textContent = "Significant market change likely";
      changeText.style.color = "var(--bad)";
    }
  }

  // ── FREE: 30-day Predicted vs Actual chart ─────────────────────
  function renderFreeChart() {
    const last30 = priceHistory.slice(-30);
    if (!last30.length) return;

    // Build predicted prices from archive data (if available)
    const predMap = {};
    archive.forEach(r => {
      if (r.date && r.predicted_avg_price_inr_per_kg) {
        predMap[r.date] = parseNum(r.predicted_avg_price_inr_per_kg);
      }
    });
    const predictedData = last30.map(p => predMap[p.date] ?? null);

    const ctx = $("chart-free").getContext("2d");
    if (chartFree) chartFree.destroy();
    chartFree = new Chart(ctx, {
      type: "line",
      data: {
        labels: last30.map(p => p.date),
        datasets: [
          {
            label: "Actual Price",
            data: last30.map(p => p.avg_price),
            borderColor: "#0b3d91", borderWidth: 2, tension: 0.3,
            fill: true, backgroundColor: "rgba(11,61,145,0.06)",
            pointRadius: 0, pointHitRadius: 8
          },
          {
            label: "Predicted Price",
            data: predictedData,
            borderColor: "#059669", borderWidth: 2, tension: 0.3,
            borderDash: [5, 3], pointRadius: 0, pointHitRadius: 8,
            fill: false
          }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        scales: {
          x: { display: true, ticks: { maxTicksToShow: 6, font: { size: 11 } } },
          y: { ticks: { callback: v => INR(v), font: { size: 11 } } }
        },
        plugins: {
          legend: { display: true, position: "top", labels: { boxWidth: 12, font: { size: 11 } } },
          tooltip: { callbacks: { label: ctx => ctx.dataset.label + ": " + INR(ctx.parsed.y) } }
        }
      }
    });
  }

  // ── SUBSCRIBER: Forecasts table ────────────────────────────────
  function renderForecasts(data) {
    const tbody = $("forecast-tbl").querySelector("tbody");
    tbody.innerHTML = "";
    (data.forecasts || []).forEach(f => {
      const tr = document.createElement("tr");
      const horizon = f.horizon_days + "-day";
      const range = f.lower_bound ? INR(f.lower_bound) + " – " + INR(f.upper_bound) : "—";
      [horizon, f.target_date, INR(f.predicted_price), range, f.model_version || "—"].forEach(v => {
        const td = document.createElement("td");
        td.textContent = v;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  // ── SUBSCRIBER: Accuracy KPIs ──────────────────────────────────
  function renderAccuracyKPIs() {
    const enriched = enrichArchive(archive);
    const recent = enriched.filter(r => r.actual != null && r.pred != null).slice(-30);
    const n = recent.length || 1;
    const mape = recent.reduce((a, r) => a + (r.pctErr ?? 0), 0) / n;
    const rmse = Math.sqrt(recent.reduce((a, r) => a + Math.pow(r.absErr ?? 0, 2), 0) / n);
    const avgScore = recent.reduce((a, r) => a + (r.score ?? 0), 0) / n;
    const hitRate = recent.filter(r => r.pctErr != null && r.pctErr <= 0.05).length / n;

    $("kpi-mape").textContent = (mape * 100).toFixed(1) + "%";
    $("kpi-rmse").textContent = INR(rmse);
    $("kpi-score").textContent = avgScore.toFixed(1);
    $("kpi-hitrate").textContent = (hitRate * 100).toFixed(0) + "%";
  }

  function enrichArchive(rows) {
    return rows.map(r => {
      const actual = parseNum(r.actual_avg_price_inr_per_kg);
      const pred = parseNum(r.predicted_avg_price_inr_per_kg);
      const absErr = (actual != null && pred != null) ? Math.abs(pred - actual) : null;
      const pctErr = (actual != null && pred != null && actual !== 0) ? absErr / actual : null;
      const score = pctErr != null ? Math.max(0, 100 * (1 - pctErr)) : null;
      return { ...r, actual, pred, absErr, pctErr, score };
    });
  }

  // ── SUBSCRIBER: Deviation table ────────────────────────────────
  function renderDeviation() {
    const enriched = enrichArchive(archive);
    const withBoth = enriched.filter(r => r.actual != null && r.pred != null).slice(-30);
    const tbody = $("tbl-deviation").querySelector("tbody");
    tbody.innerHTML = "";
    if (withBoth.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="muted" style="text-align:center;padding:20px;">Deviation data will appear as forecasts mature and are validated against actuals.</td></tr>';
      return;
    }
    withBoth.forEach(r => {
      const tr = document.createElement("tr");
      [r.date, INR(r.actual), INR(r.pred), INR(r.absErr),
       r.pctErr != null ? (r.pctErr * 100).toFixed(1) + "%" : "—",
       r.score != null ? r.score.toFixed(1) : "—"
      ].forEach(v => {
        const td = document.createElement("td");
        td.textContent = v;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  // ── SUBSCRIBER: Price history chart ────────────────────────────
  function renderSubscriberChart(days) {
    const data = days === 0 ? priceHistory : priceHistory.slice(-days);
    if (!data.length) return;
    const ctx = $("chart-subscriber").getContext("2d");
    if (chartSub) chartSub.destroy();
    chartSub = new Chart(ctx, {
      type: "line",
      data: {
        labels: data.map(p => p.date),
        datasets: [
          { label: "Avg Price", data: data.map(p => p.avg_price), borderColor: "#0b3d91", borderWidth: 2, tension: 0.3, pointRadius: 0, pointHitRadius: 8, fill: true, backgroundColor: "rgba(11,61,145,0.05)" },
          { label: "Max Price", data: data.map(p => p.max_price), borderColor: "#f59e0b", borderWidth: 1.5, tension: 0.3, pointRadius: 0, borderDash: [4, 3] }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        scales: {
          x: { ticks: { maxTicksToShow: 8, font: { size: 11 } } },
          y: { ticks: { callback: v => INR(v), font: { size: 11 } } }
        },
        plugins: {
          legend: { display: true, position: "top", labels: { boxWidth: 12, font: { size: 11 } } },
          tooltip: { callbacks: { label: ctx => ctx.dataset.label + ": " + INR(ctx.parsed.y) } }
        }
      }
    });
  }

  // ── PREMIUM: 90-day forecast card ──────────────────────────────
  function renderPremiumForecast(data) {
    const fc90 = (data.forecasts || []).find(f => f.horizon_days === 90);
    if (!fc90) return;
    $("kpi-90d-price").textContent = INR(fc90.predicted_price);
    $("kpi-90d-range").textContent = fc90.lower_bound
      ? "80% range: " + INR(fc90.lower_bound) + " – " + INR(fc90.upper_bound)
      : "";
    $("kpi-90d-date").textContent = "Target: " + fc90.target_date;

    // Confidence band chart
    if (!fc90.lower_bound) return;
    const spot = data.spot_price?.avg_price || fc90.predicted_price;
    const points = [
      { x: data.spot_price?.date || "Today", mid: spot, lo: spot, hi: spot },
      { x: fc90.target_date, mid: fc90.predicted_price, lo: fc90.lower_bound, hi: fc90.upper_bound }
    ];
    // Interpolate mid-points
    const labels = [points[0].x];
    const mids = [points[0].mid];
    const los = [points[0].lo];
    const his = [points[0].hi];
    for (let i = 1; i <= 3; i++) {
      const t = i / 4;
      labels.push("");
      mids.push(spot + t * (fc90.predicted_price - spot));
      los.push(spot + t * (fc90.lower_bound - spot));
      his.push(spot + t * (fc90.upper_bound - spot));
    }
    labels.push(points[1].x);
    mids.push(points[1].mid);
    los.push(points[1].lo);
    his.push(points[1].hi);

    const ctx = $("chart-confidence").getContext("2d");
    if (chartConfidence) chartConfidence.destroy();
    chartConfidence = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          { label: "Upper Bound", data: his, borderColor: "rgba(129,140,248,0.4)", borderWidth: 1, pointRadius: 0, fill: false },
          { label: "Forecast", data: mids, borderColor: "#818cf8", borderWidth: 2.5, tension: 0.4, pointRadius: 0, fill: "-1", backgroundColor: "rgba(129,140,248,0.15)" },
          { label: "Lower Bound", data: los, borderColor: "rgba(129,140,248,0.4)", borderWidth: 1, pointRadius: 0, fill: "-1", backgroundColor: "rgba(129,140,248,0.1)" }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        scales: {
          x: { ticks: { color: "#a5b4fc", font: { size: 10 } }, grid: { color: "rgba(255,255,255,0.05)" } },
          y: { ticks: { callback: v => INR(v), color: "#a5b4fc", font: { size: 10 } }, grid: { color: "rgba(255,255,255,0.05)" } }
        },
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: ctx => ctx.dataset.label + ": " + INR(ctx.parsed.y) } }
        }
      }
    });
  }

  // ── PREMIUM: Volume analysis ───────────────────────────────────
  function renderVolumeAnalysis() {
    const last30 = priceHistory.slice(-30);
    if (!last30.length) return;
    const latest = last30[last30.length - 1];
    const avgVol = last30.reduce((a, p) => a + (p.sold_kg || 0), 0) / last30.length;
    const maxVol = Math.max(...last30.map(p => p.sold_kg || 0));

    $("kpi-vol-today").textContent = fmtK(latest.sold_kg) + " kg";
    $("kpi-vol-avg").textContent = fmtK(avgVol) + " kg";

    const tbody = $("tbl-volume").querySelector("tbody");
    tbody.innerHTML = "";
    last30.slice(-15).reverse().forEach(p => {
      const tr = document.createElement("tr");
      const pct = maxVol > 0 ? ((p.sold_kg || 0) / maxVol) * 100 : 0;
      [
        p.date,
        fmtK(p.sold_kg),
        INR(p.avg_price),
        `<span class="vol-bar" style="width:${pct}%"></span>`
      ].forEach((v, i) => {
        const td = document.createElement("td");
        if (i === 3) td.innerHTML = v; else td.textContent = v;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  // ── PREMIUM: Full overlay chart ────────────────────────────────
  function renderPremiumChart(days) {
    const data = days === 0 ? priceHistory : priceHistory.slice(-days);
    if (!data.length) return;

    // Add forecast points
    const forecastDates = [];
    const forecastPrices = [];
    if (dashboardData?.forecasts) {
      dashboardData.forecasts.forEach(f => {
        forecastDates.push(f.target_date);
        forecastPrices.push(f.predicted_price);
      });
    }

    const allLabels = [...data.map(p => p.date), ...forecastDates];
    const avgData = [...data.map(p => p.avg_price), ...new Array(forecastDates.length).fill(null)];
    const volData = data.map(p => p.sold_kg);
    const fcData = [...new Array(data.length - 1).fill(null), data[data.length - 1].avg_price, ...forecastPrices];

    const ctx = $("chart-premium").getContext("2d");
    if (chartPremium) chartPremium.destroy();
    chartPremium = new Chart(ctx, {
      type: "line",
      data: {
        labels: allLabels,
        datasets: [
          { label: "Avg Price", data: avgData, borderColor: "#818cf8", borderWidth: 2, tension: 0.3, pointRadius: 0, pointHitRadius: 8, yAxisID: "y" },
          { label: "Forecast", data: fcData, borderColor: "#34d399", borderWidth: 2.5, tension: 0.3, pointRadius: 3, borderDash: [6, 3], yAxisID: "y" },
          { label: "Volume", data: [...volData, ...new Array(forecastDates.length).fill(null)], type: "bar", backgroundColor: "rgba(129,140,248,0.15)", borderColor: "transparent", yAxisID: "y1" }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        scales: {
          x: { ticks: { color: "#a5b4fc", maxTicksToShow: 10, font: { size: 10 } }, grid: { color: "rgba(255,255,255,0.05)" } },
          y: { position: "left", ticks: { callback: v => INR(v), color: "#a5b4fc", font: { size: 10 } }, grid: { color: "rgba(255,255,255,0.06)" } },
          y1: { position: "right", ticks: { callback: v => fmtK(v), color: "#a5b4fc", font: { size: 10 } }, grid: { display: false } }
        },
        plugins: {
          legend: { display: true, position: "top", labels: { color: "#c7d2fe", boxWidth: 12, font: { size: 11 } } },
          tooltip: { callbacks: { label: ctx => ctx.dataset.label + ": " + (ctx.dataset.yAxisID === "y1" ? fmtK(ctx.parsed.y) + " kg" : INR(ctx.parsed.y)) } }
        }
      }
    });
  }

  // ── PREMIUM: Track record ──────────────────────────────────────
  function renderTrackRecord() {
    if (!trackRecord) return;
    const tbody = $("tbl-track").querySelector("tbody");
    tbody.innerHTML = "";
    const horizons = trackRecord.metrics_by_horizon || {};
    if (Object.keys(horizons).length === 0 && trackRecord.total_predictions === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:16px;opacity:0.6;">Track record will populate as forecasts mature and are validated against actual prices.</td></tr>';
      return;
    }
    Object.entries(horizons).forEach(([h, m]) => {
      const tr = document.createElement("tr");
      [h + "-day", m.count || "—", m.mape ? (m.mape * 100).toFixed(1) + "%" : "—", m.rmse ? INR(m.rmse) : "—", m.hit_rate ? (m.hit_rate * 100).toFixed(0) + "%" : "—"].forEach(v => {
        const td = document.createElement("td");
        td.textContent = v;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  // ── Tab navigation ─────────────────────────────────────────────
  function setupTabs(containerId, renderFn) {
    const container = $(containerId);
    if (!container) return;
    container.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        container.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        renderFn(parseInt(btn.dataset.range));
      });
    });
  }

  // ── Boot ───────────────────────────────────────────────────────
  setupTabs("chart-tabs", renderSubscriberChart);
  setupTabs("premium-chart-tabs", renderPremiumChart);
  loadAll();
</script>
</body>
</html>
