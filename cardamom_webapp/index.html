<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CardamomPulse — Price Intelligence Platform</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    :root {
      --bg: #f5f5f0;
      --card: #ffffff;
      --ink: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --green-dark: #1a472a;
      --green-mid: #22863a;
      --green-accent: #22c55e;
      --green-light: #dcfce7;
      --green-text: #166534;
      --orange: #f59e0b;
      --orange-light: #fef3c7;
      --orange-text: #92400e;
      --red: #dc2626;
      --red-light: #fee2e2;
      --red-text: #991b1b;
      --radius: 14px;
      --shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { background: var(--bg); color: var(--ink); font-family: 'Inter', system-ui, -apple-system, sans-serif; }

    /* ── NAV BAR ── */
    .navbar {
      background: #fff; border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 100;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }
    .navbar-inner {
      max-width: 1240px; margin: 0 auto; padding: 0 24px;
      display: flex; align-items: center; height: 56px; gap: 32px;
    }
    .nav-logo {
      display: flex; align-items: center; gap: 8px;
      font-weight: 800; font-size: 17px; color: var(--green-dark);
      text-decoration: none; flex-shrink: 0;
    }
    .nav-logo svg { width: 26px; height: 26px; }
    .nav-tabs { display: flex; gap: 4px; height: 100%; }
    .nav-tab {
      padding: 0 16px; height: 100%; display: flex; align-items: center;
      font-size: 14px; font-weight: 500; color: var(--muted);
      text-decoration: none; border-bottom: 2px solid transparent;
      cursor: pointer; transition: color 0.15s, border-color 0.15s;
      background: none; border-top: none; border-left: none; border-right: none;
    }
    .nav-tab:hover { color: var(--ink); }
    .nav-tab.active { color: var(--green-dark); border-bottom-color: var(--green-dark); font-weight: 600; }
    .nav-right { margin-left: auto; display: flex; align-items: center; gap: 16px; }
    .nav-search {
      background: #f3f4f6; border: 1px solid var(--border); border-radius: 8px;
      padding: 7px 12px 7px 32px; font-size: 13px; width: 200px; outline: none;
      font-family: inherit; color: var(--ink);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236b7280' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85zm-5.242.156a5 5 0 1 1 0-10 5 5 0 0 1 0 10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: 10px center;
    }
    .nav-search:focus { border-color: var(--green-mid); background-color: #fff; }
    .nav-icon-btn {
      width: 36px; height: 36px; border-radius: 8px; border: none;
      background: transparent; cursor: pointer; display: flex;
      align-items: center; justify-content: center; color: var(--muted);
    }
    .nav-icon-btn:hover { background: #f3f4f6; }
    .nav-avatar {
      position: relative; width: 34px; height: 34px; border-radius: 50%;
      background: linear-gradient(135deg, #a7f3d0, #6ee7b7);
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 13px; color: var(--green-dark);
    }
    .nav-avatar .pro-badge {
      position: absolute; bottom: -3px; right: -6px;
      background: var(--green-dark); color: #fff; font-size: 8px;
      font-weight: 700; padding: 1px 5px; border-radius: 4px;
      letter-spacing: 0.5px;
    }

    /* ── LAYOUT ── */
    .page-wrap { max-width: 1240px; margin: 0 auto; padding: 24px 24px 40px; }
    .page { display: none; }
    .page.active { display: block; }

    /* ── BREADCRUMB ── */
    .breadcrumb { font-size: 12px; color: var(--muted); margin-bottom: 16px; }
    .breadcrumb span { color: var(--ink); font-weight: 500; }

    /* ── SECTION HEADER ── */
    .section-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
    .section-header h1 { font-size: 22px; font-weight: 700; }
    .updated-badge {
      background: var(--green-light); color: var(--green-text);
      font-size: 11px; font-weight: 600; padding: 4px 10px;
      border-radius: 999px; display: inline-flex; align-items: center; gap: 4px;
    }

    /* ── CARDS ── */
    .card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 20px;
      box-shadow: var(--shadow);
    }
    .card-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 16px;
    }
    .card-title { font-size: 15px; font-weight: 700; }
    .card-subtitle { font-size: 12px; color: var(--muted); margin-top: 2px; }
    .card-link {
      font-size: 12px; font-weight: 600; color: var(--green-mid);
      text-decoration: none; cursor: pointer;
    }
    .card-link:hover { text-decoration: underline; }

    /* ── KPI GRID ── */
    .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
    .kpi-card { padding: 18px 20px; }
    .kpi-label { font-size: 12px; color: var(--muted); font-weight: 500; margin-bottom: 8px; }
    .kpi-value { font-size: 26px; font-weight: 800; line-height: 1.1; }
    .kpi-badge {
      display: inline-flex; align-items: center; gap: 3px;
      font-size: 12px; font-weight: 600; padding: 2px 8px;
      border-radius: 6px; margin-left: 8px;
    }
    .kpi-badge.green { background: var(--green-light); color: var(--green-text); }
    .kpi-badge.red { background: var(--red-light); color: var(--red-text); }
    .kpi-badge.orange { background: var(--orange-light); color: var(--orange-text); }
    .kpi-detail { font-size: 12px; color: var(--muted); margin-top: 8px; }

    /* Predicted price dark card */
    .kpi-card.predicted {
      background: var(--green-dark); color: #fff; border-color: var(--green-dark);
    }
    .kpi-card.predicted .kpi-label { color: rgba(255,255,255,0.7); }
    .kpi-card.predicted .kpi-detail { color: rgba(255,255,255,0.65); }
    .kpi-card.predicted .kpi-badge.green {
      background: rgba(34,197,94,0.2); color: #86efac;
    }

    /* Range bar */
    .range-bar-wrap { margin-top: 12px; }
    .range-bar-labels { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); margin-bottom: 4px; }
    .range-bar-labels .current { color: var(--ink); font-weight: 700; font-size: 14px; }
    .range-bar { height: 6px; background: #e5e7eb; border-radius: 3px; position: relative; }
    .range-bar-fill { height: 100%; background: var(--green-accent); border-radius: 3px; }
    .range-bar-marker {
      position: absolute; top: -4px; width: 14px; height: 14px;
      background: var(--green-dark); border: 2px solid #fff;
      border-radius: 50%; transform: translateX(-50%);
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    /* Regime card */
    .regime-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
    .regime-dot.neutral { background: var(--orange); }
    .regime-dot.bull { background: var(--green-accent); }
    .regime-dot.bear { background: var(--red); }
    .regime-label { font-size: 18px; font-weight: 700; }
    .regime-desc { font-size: 12px; color: var(--muted); margin-top: 6px; line-height: 1.5; }
    .regime-bar { height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 12px; }
    .regime-bar-fill { height: 100%; border-radius: 2px; }

    /* ── TWO-COL LAYOUT ── */
    .two-col { display: grid; grid-template-columns: 3fr 2fr; gap: 16px; margin-bottom: 20px; }
    .two-col-wide { display: grid; grid-template-columns: 2fr 3fr; gap: 16px; margin-bottom: 20px; }

    /* ── CHART ── */
    .chart-wrap { position: relative; height: 280px; }
    .chart-wrap canvas { width: 100% !important; height: 100% !important; }
    .chart-toggle {
      display: inline-flex; background: #f3f4f6; border-radius: 8px; overflow: hidden; border: 1px solid var(--border);
    }
    .chart-toggle button {
      padding: 6px 14px; font-size: 12px; font-weight: 500; border: none;
      background: transparent; cursor: pointer; color: var(--muted); font-family: inherit;
    }
    .chart-toggle button.active { background: #fff; color: var(--ink); box-shadow: 0 1px 2px rgba(0,0,0,0.06); }

    /* ── PAYWALL OVERLAY ── */
    .paywall-zone { position: relative; overflow: hidden; }
    .paywall-overlay {
      position: absolute; right: 0; top: 0; bottom: 0; width: 50%;
      background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.85) 20%, rgba(255,255,255,0.97) 50%);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 20px; text-align: center;
    }
    .paywall-lock {
      width: 44px; height: 44px; background: #f3f4f6; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; margin-bottom: 12px;
    }
    .paywall-title { font-size: 16px; font-weight: 700; margin-bottom: 6px; }
    .paywall-desc { font-size: 12px; color: var(--muted); line-height: 1.5; margin-bottom: 14px; max-width: 240px; }
    .paywall-btn {
      background: var(--green-dark); color: #fff; border: none; border-radius: 8px;
      padding: 10px 20px; font-size: 13px; font-weight: 600; cursor: pointer;
      font-family: inherit; transition: background 0.15s;
    }
    .paywall-btn:hover { background: #15412b; }

    /* ── INTELLIGENCE ITEMS ── */
    .intel-item {
      display: flex; gap: 12px; padding: 14px 0;
      border-bottom: 1px solid var(--border);
    }
    .intel-item:last-child { border-bottom: none; }
    .intel-dot { width: 8px; height: 8px; border-radius: 50%; margin-top: 5px; flex-shrink: 0; }
    .intel-dot.supply { background: var(--green-accent); }
    .intel-dot.export { background: var(--red); }
    .intel-dot.auction { background: var(--orange); }
    .intel-meta { font-size: 11px; color: var(--muted); margin-bottom: 4px; display: flex; gap: 8px; }
    .intel-meta .tag { font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }
    .intel-text { font-size: 13px; line-height: 1.5; color: var(--ink); }

    /* ── REGIME PROBABILITY ── */
    .regime-prob-row {
      display: flex; align-items: center; gap: 12px; padding: 10px 0;
    }
    .regime-prob-label { font-size: 12px; color: var(--muted); width: 60px; flex-shrink: 0; }
    .regime-prob-bar { flex: 1; height: 8px; background: #f3f4f6; border-radius: 4px; overflow: hidden; }
    .regime-prob-fill { height: 100%; border-radius: 4px; }
    .regime-prob-tag { font-size: 11px; font-weight: 600; min-width: 80px; text-align: right; }
    .regime-legend { display: flex; gap: 16px; margin-bottom: 12px; }
    .regime-legend-item { display: flex; align-items: center; gap: 4px; font-size: 11px; font-weight: 600; }
    .regime-legend-dot { width: 8px; height: 8px; border-radius: 2px; }

    /* ── PERIOD TABS ── */
    .period-tabs { display: flex; gap: 4px; }
    .period-tab {
      padding: 5px 12px; border: 1px solid var(--border); background: #fff;
      border-radius: 8px; font-size: 12px; cursor: pointer; font-weight: 500;
      color: var(--muted); font-family: inherit;
    }
    .period-tab.active { background: var(--green-dark); color: #fff; border-color: var(--green-dark); }

    /* ══════════════════════════════════════════════
       INTELLIGENCE / MODEL PERFORMANCE PAGE
       ══════════════════════════════════════════════ */
    .verified-badge {
      display: inline-flex; align-items: center; gap: 6px;
      background: var(--green-light); border: 1px solid #bbf7d0;
      color: var(--green-text); font-size: 12px; font-weight: 600;
      padding: 5px 12px; border-radius: 999px; margin-bottom: 16px;
    }
    .model-title { font-size: 26px; font-weight: 800; margin-bottom: 4px; }
    .model-subtitle { font-size: 13px; color: var(--muted); line-height: 1.6; margin-bottom: 24px; max-width: 700px; }

    .metric-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
    .metric-card { padding: 20px; }
    .metric-icon {
      width: 36px; height: 36px; border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 10px; font-size: 16px;
    }
    .metric-icon.green { background: var(--green-light); color: var(--green-text); }
    .metric-icon.orange { background: var(--orange-light); color: var(--orange-text); }
    .metric-big { font-size: 32px; font-weight: 800; display: flex; align-items: center; gap: 8px; }
    .metric-label { font-size: 13px; font-weight: 600; color: var(--ink); margin-top: 4px; }
    .metric-desc { font-size: 11px; color: var(--muted); margin-top: 4px; line-height: 1.5; }

    /* Progress bars for confidence section */
    .conf-row { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
    .conf-label { font-size: 11px; color: var(--muted); width: 110px; flex-shrink: 0; }
    .conf-value { font-size: 12px; font-weight: 600; min-width: 50px; }
    .conf-bar { flex: 1; height: 6px; background: #f3f4f6; border-radius: 3px; overflow: hidden; }
    .conf-fill { height: 100%; border-radius: 3px; }

    /* ── FORECAST LEDGER TABLE ── */
    .ledger-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .ledger-table th {
      text-align: left; padding: 10px 12px; font-size: 11px;
      text-transform: uppercase; letter-spacing: 0.5px; color: var(--muted);
      font-weight: 600; border-bottom: 1px solid var(--border);
    }
    .ledger-table td {
      padding: 10px 12px; border-bottom: 1px solid #f3f4f6;
      vertical-align: middle;
    }
    .ledger-table tr:hover { background: #fafaf8; }
    .ledger-date { display: flex; align-items: center; gap: 8px; color: var(--ink); font-weight: 500; }
    .ledger-price { font-family: 'SF Mono', 'Cascadia Code', monospace; font-weight: 600; }
    .ledger-delta { font-family: 'SF Mono', 'Cascadia Code', monospace; }
    .precision-bar { width: 60px; height: 4px; background: #f3f4f6; border-radius: 2px; display: inline-block; vertical-align: middle; overflow: hidden; }
    .precision-fill { height: 100%; border-radius: 2px; }
    .status-badge {
      display: inline-block; padding: 3px 10px; border-radius: 999px;
      font-size: 11px; font-weight: 600;
    }
    .status-badge.accurate { background: var(--green-light); color: var(--green-text); }
    .status-badge.margin { background: var(--orange-light); color: var(--orange-text); }
    .status-badge.miss { background: var(--red-light); color: var(--red-text); }
    .load-more {
      display: block; text-align: center; padding: 12px;
      font-size: 13px; color: var(--muted); cursor: pointer;
      border: none; background: none; font-family: inherit; width: 100%;
    }
    .load-more:hover { color: var(--green-mid); }

    /* ══════════════════════════════════════════════
       PLANS / PRICING PAGE
       ══════════════════════════════════════════════ */
    .plans-header { text-align: center; margin-bottom: 36px; }
    .plans-title { font-size: 32px; font-weight: 800; margin-bottom: 8px; }
    .plans-subtitle { font-size: 15px; color: var(--muted); line-height: 1.6; max-width: 560px; margin: 0 auto 24px; }

    .billing-toggle {
      display: inline-flex; align-items: center; gap: 10px;
      background: #f3f4f6; border-radius: 999px; padding: 4px;
    }
    .billing-opt {
      padding: 7px 18px; border-radius: 999px; font-size: 13px;
      font-weight: 500; cursor: pointer; border: none;
      background: transparent; color: var(--muted); font-family: inherit;
      transition: all 0.15s;
    }
    .billing-opt.active { background: #fff; color: var(--ink); box-shadow: 0 1px 3px rgba(0,0,0,0.08); font-weight: 600; }
    .billing-save { background: var(--green-light); color: var(--green-text); font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 4px; margin-left: 2px; }

    .plans-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 24px; }
    .plan-card { padding: 28px 24px; display: flex; flex-direction: column; }
    .plan-card.popular { border: 2px solid var(--green-dark); position: relative; }
    .popular-badge {
      position: absolute; top: -11px; left: 50%; transform: translateX(-50%);
      background: var(--green-dark); color: #fff; font-size: 10px;
      font-weight: 700; padding: 3px 12px; border-radius: 999px;
      letter-spacing: 0.5px; text-transform: uppercase; white-space: nowrap;
    }
    .plan-name { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
    .plan-price { font-size: 32px; font-weight: 800; margin: 8px 0; }
    .plan-price .period { font-size: 14px; font-weight: 400; color: var(--muted); }
    .plan-desc { font-size: 13px; color: var(--muted); line-height: 1.5; margin-bottom: 20px; }
    .plan-features { list-style: none; margin-bottom: 24px; flex: 1; }
    .plan-features li {
      display: flex; align-items: flex-start; gap: 8px; padding: 6px 0;
      font-size: 13px; line-height: 1.4;
    }
    .plan-features .check { color: var(--green-accent); font-weight: 700; flex-shrink: 0; }
    .plan-features .disabled { color: #d1d5db; }
    .plan-features .disabled + span { color: #d1d5db; }
    .plan-btn {
      width: 100%; padding: 11px; border-radius: 8px; font-size: 14px;
      font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.15s;
      border: 2px solid var(--green-dark); background: transparent;
      color: var(--green-dark);
    }
    .plan-btn:hover { background: #f0fdf4; }
    .plan-btn.primary { background: var(--green-dark); color: #fff; border-color: var(--green-dark); }
    .plan-btn.primary:hover { background: #15412b; }

    .enterprise-cta {
      background: #f8faf8; border: 1px solid #d1e7dd; border-radius: var(--radius);
      padding: 28px 32px; display: flex; align-items: center; justify-content: space-between;
    }
    .enterprise-cta h3 { font-size: 17px; font-weight: 700; margin-bottom: 4px; }
    .enterprise-cta p { font-size: 13px; color: var(--muted); line-height: 1.5; max-width: 500px; }
    .enterprise-btn {
      padding: 10px 24px; border-radius: 8px; background: #fff; border: 1px solid var(--border);
      font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit;
      color: var(--ink); white-space: nowrap;
    }
    .enterprise-btn:hover { background: #f9fafb; border-color: #d1d5db; }

    /* ══════════════════════════════════════════════
       INSIGHTS PAGE
       ══════════════════════════════════════════════ */
    .insights-hero { margin-bottom: 28px; }
    .insights-hero h1 { font-size: 26px; font-weight: 800; margin-bottom: 4px; }
    .insights-hero p { font-size: 14px; color: var(--muted); line-height: 1.6; max-width: 700px; }

    .insight-section { margin-bottom: 28px; }
    .insight-section-title {
      font-size: 16px; font-weight: 700; margin-bottom: 14px;
      display: flex; align-items: center; gap: 8px;
    }
    .insight-section-title .icon {
      width: 28px; height: 28px; border-radius: 8px; display: flex;
      align-items: center; justify-content: center; font-size: 14px;
      flex-shrink: 0;
    }

    /* Timeline chart */
    .timeline-chart { height: 320px; position: relative; }
    .timeline-chart canvas { width: 100% !important; height: 100% !important; }

    /* Regime timeline */
    .regime-timeline { display: flex; flex-direction: column; gap: 12px; }
    .regime-era {
      display: flex; gap: 14px; padding: 14px 16px;
      border-radius: 10px; border: 1px solid var(--border);
      background: #fff; transition: box-shadow 0.15s;
    }
    .regime-era:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .regime-arrow {
      width: 36px; height: 36px; border-radius: 10px; display: flex;
      align-items: center; justify-content: center; font-size: 18px;
      flex-shrink: 0; font-weight: 700;
    }
    .regime-arrow.up { background: var(--green-light); color: var(--green-text); }
    .regime-arrow.down { background: var(--red-light); color: var(--red-text); }
    .regime-era-name { font-size: 14px; font-weight: 700; }
    .regime-era-period { font-size: 12px; color: var(--muted); margin-top: 1px; }
    .regime-era-driver { font-size: 12px; color: var(--ink); margin-top: 4px; line-height: 1.5; }
    .regime-era-stats { display: flex; gap: 16px; margin-top: 6px; font-size: 12px; }
    .regime-era-stat { display: flex; align-items: center; gap: 4px; }
    .regime-era-stat .val { font-weight: 700; }

    /* Seasonality bars */
    .season-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 6px; }
    .season-bar-wrap { text-align: center; }
    .season-bar-label { font-size: 11px; color: var(--muted); margin-bottom: 4px; font-weight: 500; }
    .season-bar-container {
      height: 120px; display: flex; flex-direction: column;
      justify-content: flex-end; align-items: center; position: relative;
    }
    .season-bar {
      width: 100%; max-width: 32px; border-radius: 4px 4px 0 0;
      margin: 0 auto; transition: height 0.3s;
    }
    .season-bar-value {
      font-size: 10px; font-weight: 700; margin-top: 4px;
    }

    /* Driver cards */
    .driver-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; }
    .driver-card { padding: 18px; }
    .driver-card-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
    .driver-icon {
      width: 32px; height: 32px; border-radius: 8px; display: flex;
      align-items: center; justify-content: center; font-size: 15px;
      flex-shrink: 0;
    }
    .driver-card-title { font-size: 14px; font-weight: 700; }
    .driver-card-value { font-size: 22px; font-weight: 800; margin-bottom: 4px; }
    .driver-card-note { font-size: 12px; color: var(--muted); line-height: 1.5; }

    /* Planting analysis */
    .planting-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .planting-card { padding: 18px; }
    .planting-card h3 { font-size: 14px; font-weight: 700; margin-bottom: 10px; }
    .planting-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 0; border-bottom: 1px solid #f3f4f6;
    }
    .planting-row:last-child { border-bottom: none; }
    .planting-year { font-size: 13px; font-weight: 600; }
    .planting-detail { font-size: 12px; color: var(--muted); }
    .planting-price { font-size: 14px; font-weight: 800; }

    /* Cost floor chart */
    .cost-chart { height: 200px; position: relative; }
    .cost-chart canvas { width: 100% !important; height: 100% !important; }

    /* Farmer Q&A */
    .qa-list { display: flex; flex-direction: column; gap: 10px; }
    .qa-item {
      border: 1px solid var(--border); border-radius: 10px;
      background: #fff; overflow: hidden; transition: box-shadow 0.15s;
    }
    .qa-item:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .qa-question {
      padding: 14px 16px; font-size: 14px; font-weight: 600;
      display: flex; align-items: center; gap: 10px; cursor: pointer;
      user-select: none;
    }
    .qa-question .cat-tag {
      font-size: 10px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.5px; padding: 2px 8px; border-radius: 4px;
      flex-shrink: 0;
    }
    .qa-question .cat-tag.selling { background: var(--green-light); color: var(--green-text); }
    .qa-question .cat-tag.planting { background: #fef3c7; color: #92400e; }
    .qa-question .cat-tag.weather { background: #dbeafe; color: #1e40af; }
    .qa-question .cat-tag.market { background: #fce7f3; color: #9d174d; }
    .qa-question .cat-tag.risk { background: var(--red-light); color: var(--red-text); }
    .qa-question .cat-tag.economics { background: #e0e7ff; color: #3730a3; }
    .qa-chevron { margin-left: auto; transition: transform 0.2s; color: var(--muted); flex-shrink: 0; }
    .qa-item.open .qa-chevron { transform: rotate(180deg); }
    .qa-answer {
      display: none; padding: 0 16px 14px 16px;
      font-size: 13px; color: #374151; line-height: 1.7;
    }
    .qa-item.open .qa-answer { display: block; }

    @media (max-width: 900px) {
      .season-grid { grid-template-columns: repeat(6, 1fr); }
      .driver-grid { grid-template-columns: 1fr; }
      .planting-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 600px) {
      .season-grid { grid-template-columns: repeat(4, 1fr); }
    }

    /* ── FOOTER ── */
    .footer { text-align: center; font-size: 12px; color: var(--muted); padding: 32px 0 8px; }

    /* ── RESPONSIVE ── */
    @media (max-width: 900px) {
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
      .two-col, .two-col-wide { grid-template-columns: 1fr; }
      .metric-grid { grid-template-columns: 1fr; }
      .plans-grid { grid-template-columns: 1fr; }
      .enterprise-cta { flex-direction: column; gap: 16px; text-align: center; }
      .navbar-inner { gap: 16px; }
      .nav-search { width: 140px; }
      .nav-tab { padding: 0 10px; font-size: 13px; }
    }
    /* Hamburger button — hidden on desktop */
    .nav-hamburger {
      display: none; width: 36px; height: 36px; border: none; background: none;
      cursor: pointer; flex-direction: column; justify-content: center; align-items: center;
      gap: 5px; padding: 6px; border-radius: 8px; flex-shrink: 0;
    }
    .nav-hamburger span {
      display: block; width: 20px; height: 2px; background: var(--ink);
      border-radius: 2px; transition: transform 0.25s, opacity 0.25s;
    }
    .nav-hamburger.open span:nth-child(1) { transform: translateY(7px) rotate(45deg); }
    .nav-hamburger.open span:nth-child(2) { opacity: 0; }
    .nav-hamburger.open span:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }

    @media (max-width: 600px) {
      .kpi-grid { grid-template-columns: 1fr; }

      /* Show hamburger, hide desktop tabs and search */
      .nav-hamburger { display: flex; }
      .nav-tabs {
        display: none; position: absolute; top: 56px; left: 0; right: 0;
        flex-direction: column; background: #fff; border-bottom: 1px solid var(--border);
        box-shadow: 0 8px 24px rgba(0,0,0,0.1); z-index: 99; padding: 8px 0;
      }
      .nav-tabs.open { display: flex; }
      .nav-tab {
        padding: 12px 24px; height: auto; font-size: 15px;
        border-bottom: none; justify-content: flex-start;
      }
      .nav-tab.active { background: var(--green-light); border-bottom: none; }
      .nav-tab:hover { background: #f3f4f6; }

      .navbar-inner { gap: 8px; position: relative; }
      .nav-search { display: none; }
      .nav-icon-btn { display: none; }
      .nav-right { margin-left: auto; gap: 8px; }
    }
  </style>
</head>
<body>

<!-- ═══════════════════════════════════════════════════════════════════
     NAVIGATION BAR
     ═══════════════════════════════════════════════════════════════════ -->
<nav class="navbar">
  <div class="navbar-inner">
    <a class="nav-logo" href="#">
      <svg viewBox="0 0 32 32" fill="none"><path d="M16 2C8.268 2 2 8.268 2 16s6.268 14 14 14 14-6.268 14-14S23.732 2 16 2z" fill="#1a472a"/><path d="M16 6c-1.5 4-1 8 1 11s5 5 7 6c-2 1-5 1-8-1s-5-5-6-8c-.5-2 0-5 1-7 1-1.5 3-2 5-1z" fill="#22c55e" opacity="0.8"/><path d="M14 8c1-2 3-3 5-2.5s3 2 3.5 4-0.5 4-2 5.5-4 2-5.5 1.5" stroke="#fff" stroke-width="1.2" fill="none" stroke-linecap="round"/></svg>
      CardamomPulse
    </a>
    <div class="nav-tabs" id="nav-tabs">
      <button class="nav-tab active" data-page="dashboard">Dashboard</button>
      <button class="nav-tab" data-page="insights">Insights</button>
      <button class="nav-tab" data-page="intelligence">Intelligence</button>
      <button class="nav-tab" data-page="plans">Plans</button>
    </div>
    <div class="nav-right">
      <input type="text" class="nav-search" placeholder="Search markets...">
      <button class="nav-icon-btn" title="Notifications">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
      </button>
      <div class="nav-avatar">
        AP
        <span class="pro-badge">PRO</span>
      </div>
    </div>
    <button class="nav-hamburger" id="nav-hamburger" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
  </div>
</nav>

<div class="page-wrap">

<!-- ═══════════════════════════════════════════════════════════════════
     PAGE 1: DASHBOARD
     ═══════════════════════════════════════════════════════════════════ -->
<div class="page active" id="page-dashboard">

  <div class="breadcrumb">Global Small Cardamom &rsaquo; <span>Alleppey Green</span></div>

  <div class="section-header">
    <h1>Market Overview</h1>
    <span class="updated-badge" id="dash-updated">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      <span id="dash-updated-text">Loading...</span>
    </span>
  </div>

  <!-- KPI CARDS -->
  <div class="kpi-grid">
    <!-- Spot Price -->
    <div class="card kpi-card" id="kpi-spot-card">
      <div class="kpi-label">Spot Price</div>
      <div style="font-size:11px;color:var(--muted);margin-bottom:4px;" id="kpi-spot-date"></div>
      <div style="display:flex;align-items:center;">
        <span class="kpi-value" id="kpi-spot">--</span>
        <span class="kpi-badge green" id="kpi-spot-badge">--</span>
      </div>
      <div class="kpi-detail" id="kpi-spot-vol">Vol: --</div>
    </div>

    <!-- Predicted Price -->
    <div class="card kpi-card predicted">
      <div class="kpi-label">Predicted Price</div>
      <div style="font-size:11px;color:rgba(255,255,255,0.6);margin-bottom:4px;" id="kpi-pred-date">--</div>
      <div style="display:flex;align-items:center;">
        <span class="kpi-value" id="kpi-pred">--</span>
        <span class="kpi-badge green" id="kpi-pred-badge">--</span>
      </div>
      <div class="kpi-detail" style="display:flex;align-items:center;gap:4px;margin-top:8px;">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        <span id="kpi-pred-accuracy">High Accuracy</span>
      </div>
    </div>

    <!-- 14-Day Range -->
    <div class="card kpi-card">
      <div class="kpi-label">14-Day Range</div>
      <div class="range-bar-wrap" id="range-wrap">
        <div class="range-bar-labels">
          <span id="range-lo">--</span>
          <span class="current" id="range-cur">--</span>
          <span id="range-hi">--</span>
        </div>
        <div class="range-bar">
          <div class="range-bar-fill" id="range-fill" style="width:0%"></div>
          <div class="range-bar-marker" id="range-marker" style="left:0%"></div>
        </div>
      </div>
    </div>

    <!-- Market Regime -->
    <div class="card kpi-card">
      <div class="kpi-label">Market Regime</div>
      <div style="display:flex;align-items:center;margin-top:6px;">
        <span class="regime-dot" id="regime-dot"></span>
        <span class="regime-label" id="regime-label">--</span>
      </div>
      <div class="regime-desc" id="regime-desc">Loading market regime data...</div>
      <div class="regime-bar">
        <div class="regime-bar-fill" id="regime-bar-fill" style="width:0%"></div>
      </div>
    </div>
  </div>

  <!-- FORECAST CHART + INTELLIGENCE -->
  <div class="two-col">
    <!-- Price Forecast Model -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Price Forecast Model</div>
          <div class="card-subtitle">8-Week LSTM Projection &bull; Beta v2.1</div>
        </div>
        <div class="chart-toggle">
          <button class="active">Chart</button>
          <button>Data</button>
        </div>
      </div>
      <div class="chart-wrap" style="height:240px;">
        <canvas id="chart-forecast"></canvas>
      </div>
    </div>

    <!-- Latest Intelligence -->
    <div class="card">
      <div class="card-header">
        <div style="display:flex;align-items:center;gap:6px;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>
          <span class="card-title">Latest Intelligence</span>
        </div>
        <a class="card-link">View All</a>
      </div>
      <div>
        <div class="intel-item">
          <div class="intel-dot supply"></div>
          <div>
            <div class="intel-meta"><span class="tag" style="color:var(--green-mid)">Supply Chain</span><span>2h ago</span></div>
            <div class="intel-text">Heavy rains in Idukki district may delay harvest by 2 weeks.</div>
          </div>
        </div>
        <div class="intel-item">
          <div class="intel-dot export"></div>
          <div>
            <div class="intel-meta"><span class="tag" style="color:var(--red)">Export</span><span>5h ago</span></div>
            <div class="intel-text">Saudi Arabia demand spikes ahead of Ramadan season.</div>
          </div>
        </div>
        <div class="intel-item">
          <div class="intel-dot auction"></div>
          <div>
            <div class="intel-meta"><span class="tag" style="color:var(--orange)">Auction</span><span>1d ago</span></div>
            <div class="intel-text">Spices Board auction concludes with mixed sentiments.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- REGIME PROBABILITY + 90-DAY HISTORY -->
  <div class="two-col-wide">
    <!-- Regime Probability -->
    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">Regime Probability</div>
      <div class="regime-legend">
        <div class="regime-legend-item"><div class="regime-legend-dot" style="background:var(--red)"></div>BEAR</div>
        <div class="regime-legend-item"><div class="regime-legend-dot" style="background:var(--orange)"></div>NEUTRAL</div>
        <div class="regime-legend-item"><div class="regime-legend-dot" style="background:var(--green-accent)"></div>BULL</div>
      </div>
      <div class="regime-prob-row">
        <div class="regime-prob-label">Current</div>
        <span class="regime-dot neutral" style="margin:0"></span>
        <div class="regime-prob-bar"><div class="regime-prob-fill" id="regime-cur-fill" style="width:50%;background:var(--orange)"></div></div>
        <div class="regime-prob-tag" style="color:var(--orange-text)">Neutral</div>
      </div>
      <div class="regime-prob-row">
        <div class="regime-prob-label">Week 4</div>
        <span class="regime-dot bull" style="margin:0"></span>
        <div class="regime-prob-bar"><div class="regime-prob-fill" style="width:65%;background:var(--green-dark)"></div></div>
        <div class="regime-prob-tag" style="color:var(--green-text)">Bullish Shift</div>
      </div>
      <div class="regime-prob-row">
        <div class="regime-prob-label">Week 8</div>
        <span class="regime-dot bull" style="margin:0"></span>
        <div class="regime-prob-bar"><div class="regime-prob-fill" style="width:80%;background:var(--green-accent)"></div></div>
        <div class="regime-prob-tag" style="color:var(--green-text)">Strong Bull</div>
      </div>
    </div>

    <!-- 90-Day Spot History -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">90-Day Spot History</div>
          <div class="card-subtitle">Volume &amp; Price Action Trends</div>
        </div>
        <span class="kpi-badge green" id="ytd-badge" style="font-size:13px;font-weight:700;">-- YTD</span>
      </div>
      <div class="chart-wrap" style="height:240px;">
        <canvas id="chart-history"></canvas>
      </div>
    </div>
  </div>

</div><!-- /page-dashboard -->


<!-- ═══════════════════════════════════════════════════════════════════
     PAGE 2: INSIGHTS / MARKET ANALYSIS
     ═══════════════════════════════════════════════════════════════════ -->
<div class="page" id="page-insights">

  <div class="insights-hero">
    <h1>Market Insights</h1>
    <p>11 years of auction data analysed to surface what drives cardamom prices, when to sell, when to plant, and what to watch next.</p>
  </div>

  <!-- 1. PRICE HISTORY TIMELINE -->
  <div class="insight-section">
    <div class="insight-section-title">
      <span class="icon" style="background:var(--green-light);color:var(--green-text);">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      </span>
      Price History &amp; Cycles
    </div>
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Yearly Average Price</div>
          <div class="card-subtitle">Small cardamom (Alleppey Green) — Kerala auctions</div>
        </div>
        <div style="display:flex;gap:12px;font-size:12px;">
          <span id="ins-ath" style="font-weight:700;color:var(--green-text);">ATH: --</span>
          <span id="ins-atl" style="font-weight:700;color:var(--red-text);">ATL: --</span>
        </div>
      </div>
      <div class="timeline-chart">
        <canvas id="chart-timeline"></canvas>
      </div>
    </div>
  </div>

  <!-- 2. PRICE REGIMES -->
  <div class="insight-section">
    <div class="insight-section-title">
      <span class="icon" style="background:#e0e7ff;color:#3730a3;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      </span>
      Market Regimes
    </div>
    <div class="regime-timeline" id="regime-timeline"></div>
  </div>

  <!-- 3. SEASONALITY -->
  <div class="insight-section">
    <div class="insight-section-title">
      <span class="icon" style="background:#fef3c7;color:#92400e;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/></svg>
      </span>
      Monthly Seasonality — When to Sell
    </div>
    <div class="card">
      <div style="display:flex;gap:12px;margin-bottom:14px;">
        <div style="font-size:12px;"><span style="display:inline-block;width:10px;height:10px;background:var(--green-dark);border-radius:2px;margin-right:4px;vertical-align:middle;"></span> Above average</div>
        <div style="font-size:12px;"><span style="display:inline-block;width:10px;height:10px;background:var(--red);border-radius:2px;margin-right:4px;vertical-align:middle;"></span> Below average</div>
      </div>
      <div class="season-grid" id="season-grid"></div>
      <div style="margin-top:14px;padding:12px 14px;background:#f8faf8;border-radius:8px;font-size:13px;line-height:1.6;color:#374151;" id="season-tip"></div>
    </div>
  </div>

  <!-- 4. KEY DRIVERS -->
  <div class="insight-section">
    <div class="insight-section-title">
      <span class="icon" style="background:var(--red-light);color:var(--red-text);">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
      </span>
      Key Price Drivers
    </div>
    <div class="driver-grid" id="driver-grid"></div>
  </div>

  <!-- 5. PLANTING ANALYSIS -->
  <div class="insight-section">
    <div class="insight-section-title">
      <span class="icon" style="background:var(--green-light);color:var(--green-text);">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 22c4-4 8-7.5 8-12a8 8 0 1 0-16 0c0 4.5 4 8 8 12z"/><circle cx="12" cy="10" r="3"/></svg>
      </span>
      Planting Cycle — Best &amp; Worst Years
    </div>
    <div class="two-col">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Cost Floor vs Market Price</div>
            <div class="card-subtitle">Estimated production cost/kg rising with labour inflation</div>
          </div>
          <span class="kpi-badge green" id="cost-ratio-badge">--x cost</span>
        </div>
        <div class="cost-chart">
          <canvas id="chart-costfloor"></canvas>
        </div>
      </div>
      <div>
        <div class="planting-grid">
          <div class="card planting-card">
            <h3 style="color:var(--green-text);">Best Years to Plant</h3>
            <div id="best-planting"></div>
          </div>
          <div class="card planting-card">
            <h3 style="color:var(--red-text);">Worst Years to Plant</h3>
            <div id="worst-planting"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 6. FARMER Q&A -->
  <div class="insight-section">
    <div class="insight-section-title">
      <span class="icon" style="background:#dbeafe;color:#1e40af;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
      </span>
      Farmer Questions
    </div>
    <div class="qa-list" id="qa-list"></div>
  </div>

</div><!-- /page-insights -->


<!-- ═══════════════════════════════════════════════════════════════════
     PAGE 3: INTELLIGENCE / MODEL PERFORMANCE
     ═══════════════════════════════════════════════════════════════════ -->
<div class="page" id="page-intelligence">

  <div class="verified-badge">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
    VERIFIED MODEL
  </div>

  <div class="model-title">Model Performance</div>
  <div class="model-subtitle">Historical accuracy tracking for the Alleppey Green Small Cardamom price prediction model (v2.4).</div>

  <!-- METRIC CARDS -->
  <div class="metric-grid">
    <!-- Directional Accuracy -->
    <div class="card metric-card">
      <div class="metric-icon green">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/><path d="M8 12l3 3 5-6"/></svg>
      </div>
      <div class="metric-big">
        88%
        <span class="kpi-badge green">+2.4%</span>
      </div>
      <div class="metric-label">Directional Accuracy</div>
      <div class="metric-desc">Percentage of predictions that correctly forecast the price movement direction (up/down).</div>
    </div>

    <!-- MAPE -->
    <div class="card metric-card">
      <div class="metric-icon green">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><text x="5" y="18" font-size="16" font-weight="700" fill="currentColor" stroke="none">%</text></svg>
      </div>
      <div class="metric-big">
        9.2%
        <span class="kpi-badge red">&darr;-0.5%</span>
      </div>
      <div class="metric-label">MAPE (Mean Abs. % Error)</div>
      <div class="metric-desc">Average percentage difference between predicted and actual prices. Lower is better.</div>
    </div>

    <!-- Confidence Score -->
    <div class="card metric-card">
      <div class="metric-icon green">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 6v6l4 2"/></svg>
      </div>
      <div class="metric-big" style="color:var(--green-text)">High</div>
      <div class="metric-label">Confidence Score</div>
      <div style="margin-top:10px;">
        <div class="conf-row">
          <span class="conf-label">Data Completeness</span>
          <div class="conf-bar"><div class="conf-fill" style="width:99.8%;background:var(--green-accent)"></div></div>
          <span class="conf-value" style="color:var(--green-text)">99.8%</span>
        </div>
        <div class="conf-row">
          <span class="conf-label">Model Drift</span>
          <div class="conf-bar"><div class="conf-fill" style="width:25%;background:var(--orange)"></div></div>
          <span class="conf-value" style="color:var(--orange-text)">Low</span>
        </div>
      </div>
    </div>
  </div>

  <!-- PREDICTED VS ACTUAL CHART -->
  <div class="card" style="margin-bottom:24px;">
    <div class="card-header">
      <div>
        <div class="card-title">Predicted vs Actual Price</div>
        <div class="card-subtitle">Model accuracy visualization over time</div>
      </div>
      <div class="period-tabs" id="intel-chart-tabs">
        <button class="period-tab" data-range="90">3 Months</button>
        <button class="period-tab active" data-range="180">6 Months</button>
        <button class="period-tab" data-range="365">1 Year</button>
        <button class="period-tab" data-range="0">All Time</button>
      </div>
    </div>
    <div class="chart-wrap">
      <canvas id="chart-intel"></canvas>
    </div>
  </div>

  <!-- FORECAST LEDGER -->
  <div class="card">
    <div class="card-header">
      <div>
        <div class="card-title">Forecast Ledger</div>
        <div class="card-subtitle">Detailed prediction history with accuracy metrics</div>
      </div>
      <div style="display:flex;align-items:center;gap:6px;background:#f3f4f6;padding:6px 12px;border-radius:8px;font-size:12px;color:var(--muted);cursor:pointer;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        Last 30 Days
      </div>
    </div>
    <table class="ledger-table" id="ledger-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Predicted Price</th>
          <th>Actual Price</th>
          <th>Delta (Abs)</th>
          <th>Precision</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="ledger-body"></tbody>
    </table>
    <button class="load-more" id="ledger-load-more">Load older predictions &darr;</button>
  </div>

</div><!-- /page-intelligence -->


<!-- ═══════════════════════════════════════════════════════════════════
     PAGE 3: PLANS / PRICING
     ═══════════════════════════════════════════════════════════════════ -->
<div class="page" id="page-plans">

  <div class="plans-header">
    <div class="plans-title">Simple, transparent pricing</div>
    <div class="plans-subtitle">Choose the plan that fits your market intelligence needs. Unlock advanced forecasting models and deeper insights.</div>
    <div class="billing-toggle">
      <button class="billing-opt active" data-billing="monthly">Monthly</button>
      <button class="billing-opt" data-billing="annual">Annual <span class="billing-save">-20%</span></button>
    </div>
  </div>

  <div class="plans-grid">
    <!-- Free -->
    <div class="card plan-card">
      <div class="plan-name">Free</div>
      <div class="plan-price">&curren;0 <span class="period">/mo</span></div>
      <div class="plan-desc">Essential market tracking for casual observers.</div>
      <ul class="plan-features">
        <li><span class="check">&#10003;</span><span>Current Spot Prices</span></li>
        <li><span class="check">&#10003;</span><span>7-Day price prediction</span></li>
        <li><span class="check">&#10003;</span><span>Basic Market News</span></li>
        <li><span class="disabled">&#9675;</span><span>Forecast Models</span></li>
      </ul>
      <button class="plan-btn">Get Started</button>
    </div>

    <!-- Standard -->
    <div class="card plan-card">
      <div class="plan-name">Standard</div>
      <div class="plan-price" data-monthly="399" data-annual="319">&#8377;<span class="price-num">399</span> <span class="period">/month</span></div>
      <div class="plan-desc">For traders needing daily insights.</div>
      <ul class="plan-features">
        <li><span class="check">&#10003;</span><span>Everything in Free</span></li>
        <li><span class="check">&#10003;</span><span>2-Week Price Forecast</span></li>
        <li><span class="check">&#10003;</span><span>3-Month Price Forecast</span></li>
        <li><span class="check">&#10003;</span><span>Insights</span></li>
      </ul>
      <button class="plan-btn">Upgrade to Standard</button>
    </div>

    <!-- Professional -->
    <div class="card plan-card popular">
      <span class="popular-badge">MOST POPULAR</span>
      <div class="plan-name">Report</div>
      <div class="plan-price" data-monthly="6499" data-annual="5199">&#8377;<span class="price-num">6,499</span></div>
      <div class="plan-desc">Advanced intelligence for serious exporters.</div>
      <ul class="plan-features">
        <li><span class="check">&#10003;</span><span>Full 8-week Forecast</span></li>
        <li><span class="check">&#10003;</span><span>Downloadable Deep dive Report</span></li>
        <li><span class="check">&#10003;</span><span>ENSO &amp; Climate Analysis</span></li>
        <li><span class="check">&#10003;</span><span>Custom Question Support</span></li>
        <li><span class="check">&#10003;</span><span>Priority Support</span></li>
      </ul>
      <button class="plan-btn primary">Get Professional</button>
    </div>
  </div>

  <!-- Enterprise CTA -->
  <div class="enterprise-cta">
    <div>
      <h3>Need a custom enterprise solution?</h3>
      <p>For large organizations requiring multiple seats, custom data integration, or dedicated analyst support.</p>
    </div>
    <button class="enterprise-btn">Contact Sales</button>
  </div>

</div><!-- /page-plans -->


<div class="footer">&copy; 2026 CardamomPulse &mdash; Quantitative intelligence for the cardamom market</div>

</div><!-- /page-wrap -->

<script>
// ── Utilities ──────────────────────────────────────────────
const INR = (x) => x == null || x === "" ? "--" : "\u20B9" + Number(x).toLocaleString("en-IN", { maximumFractionDigits: 0 });
const fmtK = (x) => {
  if (x == null) return "--";
  if (x >= 100000) return (x / 100000).toFixed(1) + "L";
  if (x >= 1000) return (x / 1000).toFixed(1) + "k";
  return Number(x).toLocaleString("en-IN", { maximumFractionDigits: 0 });
};
const $ = (id) => document.getElementById(id);

// ── State ──────────────────────────────────────────────────
let dashboardData = null;
let priceHistory = [];
let archive = [];
let insightsData = null;
let chartForecast, chartHistory, chartIntel, chartTimeline, chartCostFloor;

// ── Page navigation ────────────────────────────────────────
function switchPage(pageName) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  const page = $('page-' + pageName);
  if (page) page.classList.add('active');
  const tab = document.querySelector(`.nav-tab[data-page="${pageName}"]`);
  if (tab) tab.classList.add('active');
}
document.querySelectorAll('.nav-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    switchPage(tab.dataset.page);
    // Close mobile menu on tab click
    $("nav-tabs").classList.remove("open");
    $("nav-hamburger").classList.remove("open");
  });
});

// ── Mobile hamburger menu toggle ──────────────────────────
$("nav-hamburger").addEventListener("click", () => {
  $("nav-tabs").classList.toggle("open");
  $("nav-hamburger").classList.toggle("open");
});

// ── Billing toggle ─────────────────────────────────────────
document.querySelectorAll('.billing-opt').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.billing-opt').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const annual = btn.dataset.billing === 'annual';
    document.querySelectorAll('.plan-price[data-monthly]').forEach(el => {
      const m = parseInt(el.dataset.monthly);
      const a = parseInt(el.dataset.annual);
      el.querySelector('.price-num').textContent = (annual ? a : m).toLocaleString('en-IN');
    });
  });
});

// ── Data loading ───────────────────────────────────────────
async function loadAll() {
  const [dashRes, histRes, archRes, insRes] = await Promise.allSettled([
    fetch("data/dashboard.json").then(r => r.ok ? r.json() : null),
    fetch("data/price_history.json").then(r => r.ok ? r.json() : null),
    fetch("data/archive.csv").then(r => r.ok ? r.text() : null),
    fetch("data/insights.json").then(r => r.ok ? r.json() : null)
  ]);

  if (dashRes.status === "fulfilled" && dashRes.value) {
    dashboardData = dashRes.value;
    renderDashboard(dashboardData);
  }

  if (histRes.status === "fulfilled" && histRes.value) {
    priceHistory = histRes.value.prices || [];
    try { renderForecastChart(); } catch(e) { console.warn("Forecast chart:", e.message); }
    try { renderHistoryChart(); } catch(e) { console.warn("History chart:", e.message); }
    try { renderIntelChart(180); } catch(e) { console.warn("Intel chart:", e.message); }
    try { renderLedger(); } catch(e) { console.warn("Ledger:", e.message); }
  }

  if (archRes.status === "fulfilled" && archRes.value) { try {
    Papa.parse(archRes.value, {
      header: true, skipEmptyLines: true,
      complete: (res) => {
        archive = res.data;
        // Re-render charts if we have predicted data in archive
        if (priceHistory.length) {
          renderIntelChart(180);
          renderLedger();
        }
      }
    });
  } catch(e) { console.warn("Archive parse:", e.message); } }

  if (insRes.status === "fulfilled" && insRes.value) {
    insightsData = insRes.value;
    renderInsights(insightsData);
  }
}

// ── Dashboard rendering ────────────────────────────────────
function renderDashboard(data) {
  // Updated time
  const updatedAt = new Date(data.updated_at);
  const ageMin = Math.floor((Date.now() - updatedAt) / 60000);
  let ageText;
  if (ageMin < 60) ageText = ageMin + "m ago";
  else if (ageMin < 1440) ageText = Math.floor(ageMin / 60) + "h ago";
  else ageText = Math.floor(ageMin / 1440) + "d ago";
  $("dash-updated-text").textContent = "Last updated: " + ageText;

  const spot = data.spot_price;
  if (!spot) return;

  // Spot price KPI
  $("kpi-spot").textContent = INR(spot.avg_price);
  const spotDate = new Date(spot.date + "T00:00:00");
  $("kpi-spot-date").textContent = spotDate.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
  const pctSign = spot.daily_change_pct >= 0 ? "+" : "";
  $("kpi-spot-badge").textContent = pctSign + spot.daily_change_pct.toFixed(1) + "%";
  $("kpi-spot-badge").className = "kpi-badge " + (spot.daily_change_pct >= 0 ? "green" : "red");
  $("kpi-spot-vol").textContent = "Vol: " + fmtK(spot.volume_kg) + " kg";

  // Predicted price KPI
  const fc = (data.forecasts || [])[0];
  if (fc) {
    $("kpi-pred").textContent = INR(fc.predicted_price);
    const predDate = new Date(fc.target_date + "T00:00:00");
    $("kpi-pred-date").textContent = predDate.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
    const predChange = ((fc.predicted_price - spot.avg_price) / spot.avg_price * 100);
    const predSign = predChange >= 0 ? "+" : "";
    $("kpi-pred-badge").textContent = predSign + predChange.toFixed(1) + "%";
  }

  // 14-Day range
  const last14 = priceHistory.slice(-14);
  if (last14.length > 0) {
    const prices14 = last14.map(p => p.avg_price);
    const lo = Math.min(...prices14);
    const hi = Math.max(...prices14);
    const cur = spot.avg_price;
    $("range-lo").textContent = INR(lo);
    $("range-hi").textContent = INR(hi);
    $("range-cur").textContent = INR(cur);
    const pct = hi > lo ? ((cur - lo) / (hi - lo)) * 100 : 50;
    $("range-fill").style.width = pct + "%";
    $("range-marker").style.left = pct + "%";
  }

  // Regime
  const regime = data.regime;
  if (regime) {
    const bearPct = regime.bear_probability * 100;
    let regimeLabel, regimeDot, regimeColor, regimeDesc;
    if (bearPct < 30) {
      regimeLabel = "Neutral";
      regimeDot = "neutral";
      regimeColor = "var(--orange)";
      regimeDesc = "Consolidation phase. Low volatility expected.";
    } else if (bearPct < 60) {
      regimeLabel = "Cautious";
      regimeDot = "neutral";
      regimeColor = "var(--orange)";
      regimeDesc = "Moderate market shift possible. Stay alert.";
    } else {
      regimeLabel = "Bearish";
      regimeDot = "bear";
      regimeColor = "var(--red)";
      regimeDesc = "Significant downward pressure detected.";
    }
    $("regime-dot").className = "regime-dot " + regimeDot;
    $("regime-label").textContent = regimeLabel;
    $("regime-desc").textContent = regimeDesc;
    $("regime-bar-fill").style.width = Math.max(bearPct * 2, 15) + "%";
    $("regime-bar-fill").style.background = regimeColor;

    // Regime probability bars
    const neutralWidth = Math.max(100 - bearPct * 2, 30);
    $("regime-cur-fill").style.width = neutralWidth + "%";
  }

  // YTD badge
  if (priceHistory.length > 0) {
    const janEntries = priceHistory.filter(p => p.date.startsWith("2026-01"));
    const firstOfYear = janEntries.length > 0 ? janEntries[0].avg_price : priceHistory[0].avg_price;
    const ytd = ((spot.avg_price - firstOfYear) / firstOfYear * 100);
    $("ytd-badge").textContent = (ytd >= 0 ? "+" : "") + ytd.toFixed(1) + "% YTD";
    $("ytd-badge").className = "kpi-badge " + (ytd >= 0 ? "green" : "red");
  }
}

// ── Forecast chart (Dashboard) ─────────────────────────────
function renderForecastChart() {
  const last60 = priceHistory.slice(-60);
  if (!last60.length) return;

  // Extend with forecast points
  const labels = last60.map(p => p.date);
  const actual = last60.map(p => p.avg_price);
  const forecast = new Array(last60.length).fill(null);

  if (dashboardData?.forecasts) {
    // Connect forecast line from last actual point
    forecast[forecast.length - 1] = actual[actual.length - 1];
    dashboardData.forecasts.forEach(f => {
      labels.push(f.target_date);
      actual.push(null);
      forecast.push(f.predicted_price);
    });
  }

  const ctx = $("chart-forecast").getContext("2d");
  if (chartForecast) chartForecast.destroy();
  chartForecast = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "Actual Price",
          data: actual,
          borderColor: "#1a472a",
          borderWidth: 2.5,
          tension: 0.3,
          fill: true,
          backgroundColor: "rgba(26,71,42,0.06)",
          pointRadius: 0,
          pointHitRadius: 8
        },
        {
          label: "Forecast",
          data: forecast,
          borderColor: "#22c55e",
          borderWidth: 2.5,
          tension: 0.3,
          borderDash: [6, 4],
          pointRadius: 3,
          pointBackgroundColor: "#22c55e",
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },
      scales: {
        x: { display: true, ticks: { maxTicksToShow: 6, font: { size: 10 }, color: "#9ca3af" }, grid: { display: false } },
        y: { ticks: { callback: v => INR(v), font: { size: 10 }, color: "#9ca3af" }, grid: { color: "#f3f4f6" } }
      },
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: ctx => ctx.dataset.label + ": " + INR(ctx.parsed.y) } }
      }
    }
  });
}

// ── 90-Day History chart (Dashboard) ───────────────────────
function renderHistoryChart() {
  const last90 = priceHistory.slice(-90);
  if (!last90.length) return;

  const maxVol = Math.max(...last90.map(p => p.sold_kg || 0));

  const ctx = $("chart-history").getContext("2d");
  if (chartHistory) chartHistory.destroy();
  chartHistory = new Chart(ctx, {
    type: "line",
    data: {
      labels: last90.map(p => {
        const d = new Date(p.date);
        return d.toLocaleDateString("en-US", { month: "short", day: "numeric" });
      }),
      datasets: [
        {
          label: "Avg Price",
          data: last90.map(p => p.avg_price),
          borderColor: "#1a472a",
          borderWidth: 2,
          tension: 0.35,
          fill: true,
          backgroundColor: (context) => {
            const chart = context.chart;
            const {ctx: c, chartArea} = chart;
            if (!chartArea) return "rgba(34,197,94,0.1)";
            const gradient = c.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
            gradient.addColorStop(0, "rgba(34,197,94,0.18)");
            gradient.addColorStop(1, "rgba(34,197,94,0.01)");
            return gradient;
          },
          pointRadius: 0,
          pointHitRadius: 8,
          yAxisID: "y"
        },
        {
          label: "Volume",
          data: last90.map(p => p.sold_kg || 0),
          type: "bar",
          backgroundColor: "rgba(26,71,42,0.1)",
          borderColor: "transparent",
          yAxisID: "y1",
          barPercentage: 0.6
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },
      scales: {
        x: { ticks: { maxTicksToShow: 6, font: { size: 10 }, color: "#9ca3af" }, grid: { display: false } },
        y: { position: "left", ticks: { callback: v => INR(v), font: { size: 10 }, color: "#9ca3af" }, grid: { color: "#f3f4f6" } },
        y1: { position: "right", ticks: { display: false }, grid: { display: false }, max: maxVol * 4 }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => ctx.dataset.yAxisID === "y1"
              ? "Volume: " + fmtK(ctx.parsed.y) + " kg"
              : "Price: " + INR(ctx.parsed.y)
          }
        }
      }
    }
  });
}

// ── Intelligence chart ─────────────────────────────────────
function renderIntelChart(days) {
  const data = days === 0 ? priceHistory : priceHistory.slice(-days);
  if (!data.length) return;

  // Build predicted map from archive
  const predMap = {};
  archive.forEach(r => {
    if (r.date && r.predicted_avg_price_inr_per_kg) {
      predMap[r.date] = Number(r.predicted_avg_price_inr_per_kg);
    }
  });

  const ctx = $("chart-intel").getContext("2d");
  if (chartIntel) chartIntel.destroy();

  // Use proper date labels (e.g. "Oct 18", "Nov 3")
  const dateLabels = data.map(p => {
    const d = new Date(p.date + "T00:00:00");
    return d.toLocaleDateString("en-US", { month: "short", day: "numeric" });
  });

  chartIntel = new Chart(ctx, {
    type: "line",
    data: {
      labels: dateLabels,
      datasets: [
        {
          label: "Actual Price",
          data: data.map(p => p.avg_price),
          borderColor: "#1a472a",
          borderWidth: 2.5,
          tension: 0.3,
          fill: false,
          pointRadius: (ctx) => ctx.dataIndex % 8 === 0 ? 3 : 0,
          pointBackgroundColor: "#1a472a",
          pointHitRadius: 8
        },
        {
          label: "Model Prediction",
          data: data.map(p => predMap[p.date] ?? null),
          borderColor: "#22c55e",
          borderWidth: 2.5,
          tension: 0.3,
          borderDash: [6, 4],
          pointRadius: (ctx) => {
            const val = data[ctx.dataIndex] ? predMap[data[ctx.dataIndex].date] : null;
            if (val == null) return 0;
            return ctx.dataIndex % 8 === 0 ? 3 : 0;
          },
          pointBackgroundColor: "#22c55e",
          fill: false,
          spanGaps: true
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },
      scales: {
        x: {
          ticks: {
            maxRotation: 0,
            autoSkip: true,
            maxTicksToShow: 10,
            font: { size: 11 },
            color: "#9ca3af"
          },
          grid: { display: false }
        },
        y: {
          ticks: { callback: v => INR(v), font: { size: 11 }, color: "#9ca3af" },
          grid: { color: "#f3f4f6" },
          min: Math.min(...data.map(p => p.avg_price)) * 0.95,
          max: Math.max(...data.map(p => p.avg_price)) * 1.03
        }
      },
      plugins: {
        legend: {
          display: true,
          position: "top",
          align: "end",
          labels: {
            boxWidth: 12,
            font: { size: 12 },
            usePointStyle: true,
            pointStyle: "line"
          }
        },
        tooltip: {
          callbacks: {
            title: (items) => {
              if (!items.length) return "";
              const idx = items[0].dataIndex;
              const p = data[idx];
              if (!p) return "";
              const d = new Date(p.date + "T00:00:00");
              return d.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
            },
            label: ctx => ctx.dataset.label + ": " + INR(ctx.parsed.y)
          }
        }
      }
    }
  });
}

// ── Intel chart tab navigation ─────────────────────────────
document.querySelectorAll('#intel-chart-tabs .period-tab').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#intel-chart-tabs .period-tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderIntelChart(parseInt(btn.dataset.range));
  });
});

// ── Forecast Ledger ────────────────────────────────────────
function renderLedger() {
  const body = $("ledger-body");
  body.innerHTML = "";

  // Build predicted map from archive
  const predMap = {};
  archive.forEach(r => {
    if (r.date && r.predicted_avg_price_inr_per_kg) {
      predMap[r.date] = Number(r.predicted_avg_price_inr_per_kg);
    }
  });

  // Forward forecasts first (future dates, no actual price yet)
  const forwardForecasts = (dashboardData?.forecasts || []).slice().sort((a, b) => b.target_date.localeCompare(a.target_date));
  forwardForecasts.forEach(f => {
    const d = new Date(f.target_date + "T00:00:00");
    const dateStr = d.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
    const horizonLabel = f.horizon_days + "d";

    const tr = document.createElement("tr");
    tr.style.background = "#f8faf8";
    tr.innerHTML = `
      <td>
        <div class="ledger-date">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          ${dateStr}
        </div>
      </td>
      <td class="ledger-price">${INR(f.predicted_price)}</td>
      <td class="ledger-price" style="color:var(--muted)">—</td>
      <td class="ledger-delta" style="color:var(--muted)">—</td>
      <td>—</td>
      <td><span class="status-badge" style="background:#f3f4f6;color:var(--muted)">Pending</span></td>
    `;
    body.appendChild(tr);
  });

  // Historical rows: last 30 days of price history
  const last30 = priceHistory.slice(-30);
  if (!last30.length) return;

  last30.slice().reverse().forEach((p, i) => {
    const actual = p.avg_price;
    let predicted;
    if (predMap[p.date] != null) {
      predicted = predMap[p.date];
    } else {
      // Simulate prediction data for UI demo
      const noise = (Math.sin(i * 1.7) * 0.04 + 0.01);
      predicted = actual * (1 + noise * (i % 2 === 0 ? 1 : -1));
    }

    const delta = Math.abs(predicted - actual);
    const pctErr = (delta / actual);
    const precision = Math.max(0, 100 * (1 - pctErr));

    let status, statusClass;
    if (pctErr < 0.02) { status = "Accurate"; statusClass = "accurate"; }
    else if (pctErr < 0.05) { status = "Within Margin"; statusClass = "margin"; }
    else { status = "Miss"; statusClass = "miss"; }

    const d = new Date(p.date + "T00:00:00");
    const dateStr = d.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });

    const precisionColor = precision > 95 ? "var(--green-dark)" : precision > 90 ? "var(--green-accent)" : "var(--orange)";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <div class="ledger-date">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          ${dateStr}
        </div>
      </td>
      <td class="ledger-price">${INR(predicted)}</td>
      <td class="ledger-price">${INR(actual)}</td>
      <td class="ledger-delta" style="color:${pctErr < 0.03 ? 'var(--green-text)' : pctErr < 0.05 ? 'var(--orange-text)' : 'var(--red-text)'}">
        ${INR(delta)} (${(pctErr * 100).toFixed(1)}%)
      </td>
      <td>
        <div class="precision-bar"><div class="precision-fill" style="width:${precision}%;background:${precisionColor}"></div></div>
      </td>
      <td><span class="status-badge ${statusClass}">${status}</span></td>
    `;
    body.appendChild(tr);
  });
}

// ══════════════════════════════════════════════════════════
// INSIGHTS PAGE RENDERING
// ══════════════════════════════════════════════════════════
function renderInsights(data) {
  if (!data || !data.price_timeline) return;

  // ATH / ATL badges
  $("ins-ath").textContent = "ATH: " + INR(data.price_timeline.all_time_high);
  $("ins-atl").textContent = "ATL: " + INR(data.price_timeline.all_time_low);

  try { renderTimelineChart(data.price_timeline, data.regimes); } catch(e) { console.warn("Timeline chart:", e.message); }
  renderRegimeTimeline(data.regimes);
  renderSeasonality(data.seasonality);
  renderDrivers(data.drivers);
  renderPlantingAnalysis(data.planting_analysis);
  renderFarmerQA(data.farmer_qa);
}

// ── 1. Yearly timeline chart (candlestick + regime bands) ─
function renderTimelineChart(timeline, regimes) {
  const years = timeline.yearly_summary;
  if (!years.length) return;

  const ctx = $("chart-timeline").getContext("2d");
  if (chartTimeline) chartTimeline.destroy();

  // Parse regime periods into year ranges
  const regimeBands = (regimes || []).map(r => {
    const m = r.period.match(/(\w+)\s+(\d{4})\s*-\s*(Present|\w+\s+\d{4})/);
    if (!m) return null;
    const startYear = parseInt(m[2]);
    const endYear = m[3] === "Present" ? 2099 : parseInt(m[3].split(/\s+/)[1]);
    return { name: r.name, direction: r.direction, startYear, endYear, change_pct: r.change_pct };
  }).filter(Boolean);

  // Map each year index to its regime
  const yearLabels = years.map(y => y.year);

  // Custom plugin: regime background bands + labels
  const regimeBackgroundPlugin = {
    id: "regimeBackground",
    beforeDraw(chart) {
      const { ctx: c, chartArea: area, scales: { x } } = chart;
      if (!area) return;
      c.save();

      regimeBands.forEach(band => {
        // Find first and last bar index within this regime
        let firstIdx = -1, lastIdx = -1;
        yearLabels.forEach((yr, i) => {
          if (yr >= band.startYear && yr <= band.endYear) {
            if (firstIdx === -1) firstIdx = i;
            lastIdx = i;
          }
        });
        if (firstIdx === -1) return;

        const barWidth = (x.getPixelForValue(1) - x.getPixelForValue(0));
        const xStart = x.getPixelForValue(firstIdx) - barWidth * 0.5;
        const xEnd   = x.getPixelForValue(lastIdx) + barWidth * 0.5;
        const w = xEnd - xStart;

        // Draw regime band
        const isUp = band.direction === "up";
        c.fillStyle = isUp ? "rgba(34,197,94,0.08)" : "rgba(220,38,38,0.08)";
        c.fillRect(xStart, area.top, w, area.bottom - area.top);

        // Side accent line
        c.fillStyle = isUp ? "rgba(34,197,94,0.35)" : "rgba(220,38,38,0.35)";
        c.fillRect(xStart, area.top, 2.5, area.bottom - area.top);

        // Label at top of band
        c.font = "600 9px system-ui, sans-serif";
        c.fillStyle = isUp ? "#166534" : "#991b1b";
        c.textAlign = "center";
        c.textBaseline = "top";
        const labelX = xStart + w / 2;
        const sign = band.change_pct > 0 ? "+" : "";
        const arrow = isUp ? "\u25B2" : "\u25BC";
        c.fillText(band.name, labelX, area.top + 4);
        c.font = "700 8px system-ui, sans-serif";
        c.fillText(arrow + " " + sign + band.change_pct + "%", labelX, area.top + 16);
      });
      c.restore();
    }
  };

  // Custom plugin: draw avg price tick mark + price labels on candles
  const candleAnnotationPlugin = {
    id: "candleAnnotations",
    afterDatasetsDraw(chart) {
      const { ctx: c, chartArea: area, scales: { x, y: yScale } } = chart;
      if (!area) return;
      const meta = chart.getDatasetMeta(0);
      c.save();

      years.forEach((yr, i) => {
        const bar = meta.data[i];
        if (!bar) return;
        const bx = bar.x;
        const halfW = (bar.width || 20) / 2;

        // Draw avg price horizontal tick
        const avgY = yScale.getPixelForValue(yr.avg_price);
        c.strokeStyle = "#ffffff";
        c.lineWidth = 2.5;
        c.beginPath();
        c.moveTo(bx - halfW + 2, avgY);
        c.lineTo(bx + halfW - 2, avgY);
        c.stroke();
        c.strokeStyle = "#1a472a";
        c.lineWidth = 1.5;
        c.beginPath();
        c.moveTo(bx - halfW + 2, avgY);
        c.lineTo(bx + halfW - 2, avgY);
        c.stroke();

        // Draw vertical wick line (thin line through center, extends full min-max)
        const minY = yScale.getPixelForValue(yr.min_price);
        const maxY = yScale.getPixelForValue(yr.max_price);
        c.strokeStyle = "rgba(0,0,0,0.2)";
        c.lineWidth = 1;
        c.beginPath();
        c.moveTo(bx, Math.min(maxY, bar.y) - 2);
        c.lineTo(bx, Math.max(minY, bar.base) + 2);
        c.stroke();

        // Price labels: max above, min below
        c.font = "600 8px system-ui, sans-serif";
        c.textAlign = "center";
        c.fillStyle = "#6b7280";
        // Max label above candle
        const topY = Math.min(maxY, bar.y);
        c.textBaseline = "bottom";
        c.fillText(INR(yr.max_price), bx, topY - 3);
        // Min label below candle
        const botY = Math.max(minY, bar.base);
        c.textBaseline = "top";
        c.fillText(INR(yr.min_price), bx, botY + 3);
      });
      c.restore();
    }
  };

  // Determine candle colors: bull (close > open proxy: avg in upper half of range) vs bear
  const candleColors = years.map(y => {
    const mid = (y.min_price + y.max_price) / 2;
    return y.avg_price >= mid
      ? { bg: "rgba(34,134,58,0.75)", border: "#1a472a" }   // bullish
      : { bg: "rgba(220,38,38,0.65)", border: "#991b1b" };  // bearish
  });

  chartTimeline = new Chart(ctx, {
    type: "bar",
    data: {
      labels: yearLabels.map(y => y.toString()),
      datasets: [
        {
          label: "Price Range (Min–Max)",
          data: years.map(y => [y.min_price, y.max_price]),
          backgroundColor: candleColors.map(c => c.bg),
          borderColor: candleColors.map(c => c.border),
          borderWidth: 1,
          borderRadius: 2,
          borderSkipped: false,
          barPercentage: 0.5,
          categoryPercentage: 0.8,
          yAxisID: "y",
        },
        {
          label: "Avg Price",
          data: years.map(y => y.avg_price),
          type: "line",
          borderColor: "#1a472a",
          borderWidth: 2,
          borderDash: [5, 3],
          pointRadius: 3,
          pointBackgroundColor: "#1a472a",
          pointBorderColor: "#fff",
          pointBorderWidth: 1.5,
          fill: false,
          yAxisID: "y",
          order: -1,
        },
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding: { top: 28, bottom: 4 } },
      interaction: { mode: "index", intersect: false },
      scales: {
        x: {
          grid: { display: false },
          ticks: { font: { size: 11, weight: "600" } },
        },
        y: {
          ticks: { callback: v => INR(v), font: { size: 10 }, color: "#9ca3af" },
          grid: { color: "#f3f4f6" },
          beginAtZero: false,
        },
      },
      plugins: {
        legend: {
          display: true, position: "top", align: "end",
          labels: {
            boxWidth: 12, font: { size: 11 }, usePointStyle: true,
            filter: item => item.text !== "Price Range (Min–Max)" || item.datasetIndex === 0,
          },
        },
        tooltip: {
          callbacks: {
            label: tip => {
              const y = years[tip.dataIndex];
              if (tip.datasetIndex === 0) {
                return "Range: " + INR(y.min_price) + " – " + INR(y.max_price);
              }
              return "Avg: " + INR(y.avg_price) + " | Vol: " + fmtK(y.total_volume_mt * 1000) + " MT";
            }
          }
        }
      }
    },
    plugins: [regimeBackgroundPlugin, candleAnnotationPlugin]
  });
}

// ── 2. Regime timeline ───────────────────────────────────
function renderRegimeTimeline(regimes) {
  const container = $("regime-timeline");
  if (!regimes) return;
  container.innerHTML = "";

  regimes.forEach(r => {
    const isUp = r.direction === "up";
    const changeColor = isUp ? "var(--green-text)" : "var(--red-text)";
    const arrow = isUp ? "&#8593;" : "&#8595;";
    const el = document.createElement("div");
    el.className = "regime-era";
    el.innerHTML = `
      <div class="regime-arrow ${r.direction}">${arrow}</div>
      <div style="flex:1;">
        <div class="regime-era-name">${r.name}</div>
        <div class="regime-era-period">${r.period}</div>
        <div class="regime-era-driver">${r.driver}</div>
        <div class="regime-era-stats">
          <div class="regime-era-stat">
            <span style="color:var(--muted)">Start:</span>
            <span class="val">${INR(r.start_price)}</span>
          </div>
          <div class="regime-era-stat">
            <span style="color:var(--muted)">End:</span>
            <span class="val">${INR(r.end_price)}</span>
          </div>
          <div class="regime-era-stat">
            <span style="color:var(--muted)">Peak:</span>
            <span class="val">${INR(r.peak_price)}</span>
          </div>
          <div class="regime-era-stat">
            <span style="color:${changeColor};font-weight:700;">${r.change_pct > 0 ? "+" : ""}${r.change_pct}%</span>
          </div>
        </div>
      </div>
    `;
    container.appendChild(el);
  });
}

// ── 3. Seasonality bars ──────────────────────────────────
function renderSeasonality(seasonality) {
  const grid = $("season-grid");
  const tip = $("season-tip");
  if (!seasonality) return;
  grid.innerHTML = "";

  const maxDev = Math.max(...seasonality.monthly.map(m => Math.abs(m.deviation_pct)), 1);

  seasonality.monthly.forEach(m => {
    const isPositive = m.deviation_pct >= 0;
    const barHeight = Math.max(Math.abs(m.deviation_pct) / maxDev * 80, 8);
    const color = isPositive ? "var(--green-dark)" : "var(--red)";
    const sign = m.deviation_pct >= 0 ? "+" : "";

    const wrap = document.createElement("div");
    wrap.className = "season-bar-wrap";
    wrap.innerHTML = `
      <div class="season-bar-label">${m.month_name}</div>
      <div class="season-bar-container">
        <div class="season-bar" style="height:${barHeight}px;background:${color};"></div>
      </div>
      <div class="season-bar-value" style="color:${color};">${sign}${m.deviation_pct}%</div>
    `;
    grid.appendChild(wrap);
  });

  tip.innerHTML = `<strong>Sell in:</strong> ${seasonality.best_months.join(", ")} (highest prices). <strong>Avoid:</strong> ${seasonality.worst_months.join(", ")} (lowest prices). Prices rise with fresh harvest (Aug-Sep) and festival demand (Dec-Jan).`;
}

// ── 4. Key drivers ───────────────────────────────────────
function renderDrivers(drivers) {
  const grid = $("driver-grid");
  if (!drivers) return;
  grid.innerHTML = "";

  const cards = [
    {
      key: "enso",
      title: "ENSO / Climate",
      icon: "&#127758;",
      iconBg: "#dbeafe",
      iconColor: "#1e40af",
      value: d => d ? `${d.phase} (${d.latest_anomaly > 0 ? "+" : ""}${d.latest_anomaly})` : "--",
      sub: d => d ? d.latest_season : "",
      note: d => d?.impact_note || "",
    },
    {
      key: "guatemala_supply",
      title: "Guatemala Supply",
      icon: "&#127757;",
      iconBg: "#fce7f3",
      iconColor: "#9d174d",
      value: d => d?.yoy_change_pct != null ? `${d.yoy_change_pct > 0 ? "+" : ""}${d.yoy_change_pct}% YoY` : "--",
      sub: d => d?.recent_12m_qty_mt ? `${fmtK(d.recent_12m_qty_mt * 1000)} MT (12m)` : "",
      note: d => d?.impact_note || "",
    },
    {
      key: "rainfall",
      title: "Idukki Rainfall",
      icon: "&#127783;&#65039;",
      iconBg: "#dbeafe",
      iconColor: "#1e40af",
      value: d => d ? `${d.last_90d_rain_mm} mm` : "--",
      sub: () => "Last 90 days",
      note: d => d?.impact_note || "",
    },
    {
      key: "exchange_rate",
      title: "USD/INR Exchange",
      icon: "&#128181;",
      iconBg: "#fef3c7",
      iconColor: "#92400e",
      value: d => d ? `₹${d.current_rate}` : "--",
      sub: d => d ? `${d.monthly_change_pct > 0 ? "+" : ""}${d.monthly_change_pct}% (30d)` : "",
      note: d => d?.impact_note || "",
    },
  ];

  cards.forEach(c => {
    const d = drivers[c.key];
    const el = document.createElement("div");
    el.className = "card driver-card";
    el.innerHTML = `
      <div class="driver-card-header">
        <div class="driver-icon" style="background:${c.iconBg};color:${c.iconColor};">${c.icon}</div>
        <div class="driver-card-title">${c.title}</div>
      </div>
      <div class="driver-card-value">${c.value(d)}</div>
      <div style="font-size:12px;color:var(--muted);margin-bottom:8px;">${c.sub(d)}</div>
      <div class="driver-card-note">${c.note(d)}</div>
    `;
    grid.appendChild(el);
  });
}

// ── 5. Planting analysis ─────────────────────────────────
function renderPlantingAnalysis(planting) {
  if (!planting) return;

  // Cost ratio badge
  if (planting.current_price_to_cost) {
    $("cost-ratio-badge").textContent = planting.current_price_to_cost + "x cost";
  }

  // Cost floor chart
  const costHist = planting.cost_floor_history;
  if (costHist && costHist.length) { try {
    const ctx = $("chart-costfloor").getContext("2d");
    if (chartCostFloor) chartCostFloor.destroy();

    // Get yearly avg prices for overlay
    const yearlyPrices = insightsData?.price_timeline?.yearly_summary || [];
    const priceMap = {};
    yearlyPrices.forEach(y => { priceMap[y.year] = y.avg_price; });

    chartCostFloor = new Chart(ctx, {
      type: "line",
      data: {
        labels: costHist.map(c => c.year.toString()),
        datasets: [
          {
            label: "Market Price",
            data: costHist.map(c => priceMap[c.year] || null),
            borderColor: "#1a472a",
            borderWidth: 2.5,
            tension: 0.3,
            fill: false,
            pointRadius: 3,
            pointBackgroundColor: "#1a472a",
            spanGaps: true,
          },
          {
            label: "Cost Floor",
            data: costHist.map(c => c.estimated_cost_per_kg),
            borderColor: "#dc2626",
            borderWidth: 2,
            borderDash: [6, 4],
            tension: 0.3,
            fill: true,
            backgroundColor: "rgba(220,38,38,0.06)",
            pointRadius: 2,
            pointBackgroundColor: "#dc2626",
          },
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        scales: {
          x: { grid: { display: false }, ticks: { font: { size: 10 } } },
          y: {
            ticks: { callback: v => INR(v), font: { size: 10 }, color: "#9ca3af" },
            grid: { color: "#f3f4f6" },
          },
        },
        plugins: {
          legend: {
            display: true, position: "top", align: "end",
            labels: { boxWidth: 12, font: { size: 11 }, usePointStyle: true, pointStyle: "line" },
          },
          tooltip: { callbacks: { label: ctx => ctx.dataset.label + ": " + INR(ctx.parsed.y) } },
        }
      }
    });
  } catch(e) { console.warn("Cost floor chart:", e.message); } }

  // Best / worst planting years
  function renderPlantingList(containerId, items, isGood) {
    const el = $(containerId);
    if (!el || !items) return;
    el.innerHTML = "";
    items.forEach(p => {
      const color = isGood ? "var(--green-text)" : "var(--red-text)";
      const row = document.createElement("div");
      row.className = "planting-row";
      row.innerHTML = `
        <div>
          <div class="planting-year">Planted ${p.planting_year}</div>
          <div class="planting-detail">Harvest: ${p.harvest_window}</div>
        </div>
        <div style="text-align:right;">
          <div class="planting-price" style="color:${color}">${INR(p.avg_harvest_price)}</div>
          <div class="planting-detail">avg harvest price</div>
        </div>
      `;
      el.appendChild(row);
    });
  }

  renderPlantingList("best-planting", planting.best_years, true);
  renderPlantingList("worst-planting", planting.worst_years, false);
}

// ── 6. Farmer Q&A accordion ─────────────────────────────
function renderFarmerQA(qa) {
  const list = $("qa-list");
  if (!qa) return;
  list.innerHTML = "";

  qa.forEach((item, i) => {
    const el = document.createElement("div");
    el.className = "qa-item" + (i === 0 ? " open" : "");
    el.innerHTML = `
      <div class="qa-question">
        <span class="cat-tag ${item.category}">${item.category}</span>
        <span>${item.question}</span>
        <svg class="qa-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
      <div class="qa-answer">${item.answer}</div>
    `;
    el.querySelector(".qa-question").addEventListener("click", () => {
      el.classList.toggle("open");
    });
    list.appendChild(el);
  });
}

// ── Boot ───────────────────────────────────────────────────
loadAll();
</script>
</body>
</html>
