<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CardamomPulse — Price Intelligence Platform</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    :root {
      --bg: #f5f5f0;
      --card: #ffffff;
      --ink: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --green-dark: #1a472a;
      --green-mid: #22863a;
      --green-accent: #22c55e;
      --green-light: #dcfce7;
      --green-text: #166534;
      --orange: #f59e0b;
      --orange-light: #fef3c7;
      --orange-text: #92400e;
      --red: #dc2626;
      --red-light: #fee2e2;
      --red-text: #991b1b;
      --radius: 14px;
      --shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { background: var(--bg); color: var(--ink); font-family: 'Inter', system-ui, -apple-system, sans-serif; }

    /* ── NAV BAR ── */
    .navbar {
      background: #fff; border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 100;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }
    .navbar-inner {
      max-width: 1240px; margin: 0 auto; padding: 0 24px;
      display: flex; align-items: center; height: 56px; gap: 32px;
    }
    .nav-logo {
      display: flex; align-items: center; gap: 8px;
      font-weight: 800; font-size: 17px; color: var(--green-dark);
      text-decoration: none; flex-shrink: 0;
    }
    .nav-logo svg { width: 26px; height: 26px; }
    .nav-tabs { display: flex; gap: 4px; height: 100%; }
    .nav-tab {
      padding: 0 16px; height: 100%; display: flex; align-items: center;
      font-size: 14px; font-weight: 500; color: var(--muted);
      text-decoration: none; border-bottom: 2px solid transparent;
      cursor: pointer; transition: color 0.15s, border-color 0.15s;
      background: none; border-top: none; border-left: none; border-right: none;
    }
    .nav-tab:hover { color: var(--ink); }
    .nav-tab.active { color: var(--green-dark); border-bottom-color: var(--green-dark); font-weight: 600; }
    .nav-right { margin-left: auto; display: flex; align-items: center; gap: 16px; }
    .nav-search {
      background: #f3f4f6; border: 1px solid var(--border); border-radius: 8px;
      padding: 7px 12px 7px 32px; font-size: 13px; width: 200px; outline: none;
      font-family: inherit; color: var(--ink);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236b7280' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85zm-5.242.156a5 5 0 1 1 0-10 5 5 0 0 1 0 10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: 10px center;
    }
    .nav-search:focus { border-color: var(--green-mid); background-color: #fff; }
    .nav-icon-btn {
      width: 36px; height: 36px; border-radius: 8px; border: none;
      background: transparent; cursor: pointer; display: flex;
      align-items: center; justify-content: center; color: var(--muted);
    }
    .nav-icon-btn:hover { background: #f3f4f6; }
    .nav-avatar {
      position: relative; width: 34px; height: 34px; border-radius: 50%;
      background: linear-gradient(135deg, #a7f3d0, #6ee7b7);
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 13px; color: var(--green-dark);
    }
    .nav-avatar .pro-badge {
      position: absolute; bottom: -3px; right: -6px;
      background: var(--green-dark); color: #fff; font-size: 8px;
      font-weight: 700; padding: 1px 5px; border-radius: 4px;
      letter-spacing: 0.5px;
    }

    /* ── LAYOUT ── */
    .page-wrap { max-width: 1240px; margin: 0 auto; padding: 24px 24px 40px; }
    .page { display: none; }
    .page.active { display: block; }

    /* ── BREADCRUMB ── */
    .breadcrumb { font-size: 12px; color: var(--muted); margin-bottom: 16px; }
    .breadcrumb span { color: var(--ink); font-weight: 500; }

    /* ── SECTION HEADER ── */
    .section-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
    .section-header h1 { font-size: 22px; font-weight: 700; }
    .updated-badge {
      background: var(--green-light); color: var(--green-text);
      font-size: 11px; font-weight: 600; padding: 4px 10px;
      border-radius: 999px; display: inline-flex; align-items: center; gap: 4px;
    }

    /* ── CARDS ── */
    .card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 20px;
      box-shadow: var(--shadow);
    }
    .card-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 16px;
    }
    .card-title { font-size: 15px; font-weight: 700; }
    .card-subtitle { font-size: 12px; color: var(--muted); margin-top: 2px; }
    .card-link {
      font-size: 12px; font-weight: 600; color: var(--green-mid);
      text-decoration: none; cursor: pointer;
    }
    .card-link:hover { text-decoration: underline; }

    /* ── KPI GRID ── */
    .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
    .kpi-card { padding: 18px 20px; }
    .kpi-label { font-size: 12px; color: var(--muted); font-weight: 500; margin-bottom: 8px; }
    .kpi-value { font-size: 26px; font-weight: 800; line-height: 1.1; }
    .kpi-badge {
      display: inline-flex; align-items: center; gap: 3px;
      font-size: 12px; font-weight: 600; padding: 2px 8px;
      border-radius: 6px; margin-left: 8px;
    }
    .kpi-badge.green { background: var(--green-light); color: var(--green-text); }
    .kpi-badge.red { background: var(--red-light); color: var(--red-text); }
    .kpi-badge.orange { background: var(--orange-light); color: var(--orange-text); }
    .kpi-detail { font-size: 12px; color: var(--muted); margin-top: 8px; }

    /* Predicted price dark card */
    .kpi-card.predicted {
      background: var(--green-dark); color: #fff; border-color: var(--green-dark);
    }
    .kpi-card.predicted .kpi-label { color: rgba(255,255,255,0.7); }
    .kpi-card.predicted .kpi-detail { color: rgba(255,255,255,0.65); }
    .kpi-card.predicted .kpi-badge.green {
      background: rgba(34,197,94,0.2); color: #86efac;
    }

    /* Range bar */
    .range-bar-wrap { margin-top: 12px; }
    .range-bar-labels { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); margin-bottom: 4px; }
    .range-bar-labels .current { color: var(--ink); font-weight: 700; font-size: 14px; }
    .range-bar { height: 6px; background: #e5e7eb; border-radius: 3px; position: relative; }
    .range-bar-fill { height: 100%; background: var(--green-accent); border-radius: 3px; }
    .range-bar-marker {
      position: absolute; top: -4px; width: 14px; height: 14px;
      background: var(--green-dark); border: 2px solid #fff;
      border-radius: 50%; transform: translateX(-50%);
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    /* Regime card */
    .regime-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
    .regime-dot.neutral { background: var(--orange); }
    .regime-dot.bull { background: var(--green-accent); }
    .regime-dot.bear { background: var(--red); }
    .regime-label { font-size: 18px; font-weight: 700; }
    .regime-desc { font-size: 12px; color: var(--muted); margin-top: 6px; line-height: 1.5; }
    .regime-bar { height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 12px; }
    .regime-bar-fill { height: 100%; border-radius: 2px; }

    /* ── TWO-COL LAYOUT ── */
    .two-col { display: grid; grid-template-columns: 3fr 2fr; gap: 16px; margin-bottom: 20px; }
    .two-col-wide { display: grid; grid-template-columns: 2fr 3fr; gap: 16px; margin-bottom: 20px; }

    /* ── CHART ── */
    .chart-wrap { position: relative; height: 280px; }
    .chart-wrap canvas { width: 100% !important; height: 100% !important; }
    .chart-toggle {
      display: inline-flex; background: #f3f4f6; border-radius: 8px; overflow: hidden; border: 1px solid var(--border);
    }
    .chart-toggle button {
      padding: 6px 14px; font-size: 12px; font-weight: 500; border: none;
      background: transparent; cursor: pointer; color: var(--muted); font-family: inherit;
    }
    .chart-toggle button.active { background: #fff; color: var(--ink); box-shadow: 0 1px 2px rgba(0,0,0,0.06); }

    /* ── PAYWALL OVERLAY ── */
    .paywall-zone { position: relative; overflow: hidden; }
    .paywall-overlay {
      position: absolute; right: 0; top: 0; bottom: 0; width: 50%;
      background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.85) 20%, rgba(255,255,255,0.97) 50%);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 20px; text-align: center;
    }
    .paywall-lock {
      width: 44px; height: 44px; background: #f3f4f6; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; margin-bottom: 12px;
    }
    .paywall-title { font-size: 16px; font-weight: 700; margin-bottom: 6px; }
    .paywall-desc { font-size: 12px; color: var(--muted); line-height: 1.5; margin-bottom: 14px; max-width: 240px; }
    .paywall-btn {
      background: var(--green-dark); color: #fff; border: none; border-radius: 8px;
      padding: 10px 20px; font-size: 13px; font-weight: 600; cursor: pointer;
      font-family: inherit; transition: background 0.15s;
    }
    .paywall-btn:hover { background: #15412b; }

    /* ── INTELLIGENCE ITEMS ── */
    .intel-item {
      display: flex; gap: 12px; padding: 14px 0;
      border-bottom: 1px solid var(--border);
    }
    .intel-item:last-child { border-bottom: none; }
    .intel-dot { width: 8px; height: 8px; border-radius: 50%; margin-top: 5px; flex-shrink: 0; }
    .intel-dot.supply { background: var(--green-accent); }
    .intel-dot.export { background: var(--red); }
    .intel-dot.auction { background: var(--orange); }
    .intel-meta { font-size: 11px; color: var(--muted); margin-bottom: 4px; display: flex; gap: 8px; }
    .intel-meta .tag { font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }
    .intel-text { font-size: 13px; line-height: 1.5; color: var(--ink); }

    /* ── REGIME PROBABILITY ── */
    .regime-prob-row {
      display: flex; align-items: center; gap: 12px; padding: 10px 0;
    }
    .regime-prob-label { font-size: 12px; color: var(--muted); width: 60px; flex-shrink: 0; }
    .regime-prob-bar { flex: 1; height: 8px; background: #f3f4f6; border-radius: 4px; overflow: hidden; }
    .regime-prob-fill { height: 100%; border-radius: 4px; }
    .regime-prob-tag { font-size: 11px; font-weight: 600; min-width: 80px; text-align: right; }
    .regime-legend { display: flex; gap: 16px; margin-bottom: 12px; }
    .regime-legend-item { display: flex; align-items: center; gap: 4px; font-size: 11px; font-weight: 600; }
    .regime-legend-dot { width: 8px; height: 8px; border-radius: 2px; }

    /* ── PERIOD TABS ── */
    .period-tabs { display: flex; gap: 4px; }
    .period-tab {
      padding: 5px 12px; border: 1px solid var(--border); background: #fff;
      border-radius: 8px; font-size: 12px; cursor: pointer; font-weight: 500;
      color: var(--muted); font-family: inherit;
    }
    .period-tab.active { background: var(--green-dark); color: #fff; border-color: var(--green-dark); }

    /* ══════════════════════════════════════════════
       INTELLIGENCE / MODEL PERFORMANCE PAGE
       ══════════════════════════════════════════════ */
    .verified-badge {
      display: inline-flex; align-items: center; gap: 6px;
      background: var(--green-light); border: 1px solid #bbf7d0;
      color: var(--green-text); font-size: 12px; font-weight: 600;
      padding: 5px 12px; border-radius: 999px; margin-bottom: 16px;
    }
    .model-title { font-size: 26px; font-weight: 800; margin-bottom: 4px; }
    .model-subtitle { font-size: 13px; color: var(--muted); line-height: 1.6; margin-bottom: 24px; max-width: 700px; }

    .metric-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
    .metric-card { padding: 20px; }
    .metric-icon {
      width: 36px; height: 36px; border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 10px; font-size: 16px;
    }
    .metric-icon.green { background: var(--green-light); color: var(--green-text); }
    .metric-icon.orange { background: var(--orange-light); color: var(--orange-text); }
    .metric-big { font-size: 32px; font-weight: 800; display: flex; align-items: center; gap: 8px; }
    .metric-label { font-size: 13px; font-weight: 600; color: var(--ink); margin-top: 4px; }
    .metric-desc { font-size: 11px; color: var(--muted); margin-top: 4px; line-height: 1.5; }

    /* Progress bars for confidence section */
    .conf-row { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
    .conf-label { font-size: 11px; color: var(--muted); width: 110px; flex-shrink: 0; }
    .conf-value { font-size: 12px; font-weight: 600; min-width: 50px; }
    .conf-bar { flex: 1; height: 6px; background: #f3f4f6; border-radius: 3px; overflow: hidden; }
    .conf-fill { height: 100%; border-radius: 3px; }

    /* ── FORECAST LEDGER TABLE ── */
    .ledger-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .ledger-table th {
      text-align: left; padding: 10px 12px; font-size: 11px;
      text-transform: uppercase; letter-spacing: 0.5px; color: var(--muted);
      font-weight: 600; border-bottom: 1px solid var(--border);
    }
    .ledger-table td {
      padding: 10px 12px; border-bottom: 1px solid #f3f4f6;
      vertical-align: middle;
    }
    .ledger-table tr:hover { background: #fafaf8; }
    .ledger-date { display: flex; align-items: center; gap: 8px; color: var(--ink); font-weight: 500; }
    .ledger-price { font-family: 'SF Mono', 'Cascadia Code', monospace; font-weight: 600; }
    .ledger-delta { font-family: 'SF Mono', 'Cascadia Code', monospace; }
    .precision-bar { width: 60px; height: 4px; background: #f3f4f6; border-radius: 2px; display: inline-block; vertical-align: middle; overflow: hidden; }
    .precision-fill { height: 100%; border-radius: 2px; }
    .status-badge {
      display: inline-block; padding: 3px 10px; border-radius: 999px;
      font-size: 11px; font-weight: 600;
    }
    .status-badge.accurate { background: var(--green-light); color: var(--green-text); }
    .status-badge.margin { background: var(--orange-light); color: var(--orange-text); }
    .status-badge.miss { background: var(--red-light); color: var(--red-text); }
    .load-more {
      display: block; text-align: center; padding: 12px;
      font-size: 13px; color: var(--muted); cursor: pointer;
      border: none; background: none; font-family: inherit; width: 100%;
    }
    .load-more:hover { color: var(--green-mid); }

    /* ══════════════════════════════════════════════
       PLANS / PRICING PAGE
       ══════════════════════════════════════════════ */
    .plans-header { text-align: center; margin-bottom: 36px; }
    .plans-title { font-size: 32px; font-weight: 800; margin-bottom: 8px; }
    .plans-subtitle { font-size: 15px; color: var(--muted); line-height: 1.6; max-width: 560px; margin: 0 auto 24px; }

    .billing-toggle {
      display: inline-flex; align-items: center; gap: 10px;
      background: #f3f4f6; border-radius: 999px; padding: 4px;
    }
    .billing-opt {
      padding: 7px 18px; border-radius: 999px; font-size: 13px;
      font-weight: 500; cursor: pointer; border: none;
      background: transparent; color: var(--muted); font-family: inherit;
      transition: all 0.15s;
    }
    .billing-opt.active { background: #fff; color: var(--ink); box-shadow: 0 1px 3px rgba(0,0,0,0.08); font-weight: 600; }
    .billing-save { background: var(--green-light); color: var(--green-text); font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 4px; margin-left: 2px; }

    .plans-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 24px; }
    .plan-card { padding: 28px 24px; display: flex; flex-direction: column; }
    .plan-card.popular { border: 2px solid var(--green-dark); position: relative; }
    .popular-badge {
      position: absolute; top: -11px; left: 50%; transform: translateX(-50%);
      background: var(--green-dark); color: #fff; font-size: 10px;
      font-weight: 700; padding: 3px 12px; border-radius: 999px;
      letter-spacing: 0.5px; text-transform: uppercase; white-space: nowrap;
    }
    .plan-name { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
    .plan-price { font-size: 32px; font-weight: 800; margin: 8px 0; }
    .plan-price .period { font-size: 14px; font-weight: 400; color: var(--muted); }
    .plan-desc { font-size: 13px; color: var(--muted); line-height: 1.5; margin-bottom: 20px; }
    .plan-features { list-style: none; margin-bottom: 24px; flex: 1; }
    .plan-features li {
      display: flex; align-items: flex-start; gap: 8px; padding: 6px 0;
      font-size: 13px; line-height: 1.4;
    }
    .plan-features .check { color: var(--green-accent); font-weight: 700; flex-shrink: 0; }
    .plan-features .disabled { color: #d1d5db; }
    .plan-features .disabled + span { color: #d1d5db; }
    .plan-btn {
      width: 100%; padding: 11px; border-radius: 8px; font-size: 14px;
      font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.15s;
      border: 2px solid var(--green-dark); background: transparent;
      color: var(--green-dark);
    }
    .plan-btn:hover { background: #f0fdf4; }
    .plan-btn.primary { background: var(--green-dark); color: #fff; border-color: var(--green-dark); }
    .plan-btn.primary:hover { background: #15412b; }

    .enterprise-cta {
      background: #f8faf8; border: 1px solid #d1e7dd; border-radius: var(--radius);
      padding: 28px 32px; display: flex; align-items: center; justify-content: space-between;
    }
    .enterprise-cta h3 { font-size: 17px; font-weight: 700; margin-bottom: 4px; }
    .enterprise-cta p { font-size: 13px; color: var(--muted); line-height: 1.5; max-width: 500px; }
    .enterprise-btn {
      padding: 10px 24px; border-radius: 8px; background: #fff; border: 1px solid var(--border);
      font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit;
      color: var(--ink); white-space: nowrap;
    }
    .enterprise-btn:hover { background: #f9fafb; border-color: #d1d5db; }

    /* ── FOOTER ── */
    .footer { text-align: center; font-size: 12px; color: var(--muted); padding: 32px 0 8px; }

    /* ── RESPONSIVE ── */
    @media (max-width: 900px) {
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
      .two-col, .two-col-wide { grid-template-columns: 1fr; }
      .metric-grid { grid-template-columns: 1fr; }
      .plans-grid { grid-template-columns: 1fr; }
      .enterprise-cta { flex-direction: column; gap: 16px; text-align: center; }
    }
    @media (max-width: 600px) {
      .kpi-grid { grid-template-columns: 1fr; }
      .navbar-inner { gap: 12px; }
      .nav-search { width: 120px; }
      .nav-tabs { gap: 0; }
      .nav-tab { padding: 0 10px; font-size: 13px; }
    }
  </style>
</head>
<body>

<!-- ═══════════════════════════════════════════════════════════════════
     NAVIGATION BAR
     ═══════════════════════════════════════════════════════════════════ -->
<nav class="navbar">
  <div class="navbar-inner">
    <a class="nav-logo" href="#">
      <svg viewBox="0 0 32 32" fill="none"><path d="M16 2C8.268 2 2 8.268 2 16s6.268 14 14 14 14-6.268 14-14S23.732 2 16 2z" fill="#1a472a"/><path d="M16 6c-1.5 4-1 8 1 11s5 5 7 6c-2 1-5 1-8-1s-5-5-6-8c-.5-2 0-5 1-7 1-1.5 3-2 5-1z" fill="#22c55e" opacity="0.8"/><path d="M14 8c1-2 3-3 5-2.5s3 2 3.5 4-0.5 4-2 5.5-4 2-5.5 1.5" stroke="#fff" stroke-width="1.2" fill="none" stroke-linecap="round"/></svg>
      CardamomPulse
    </a>
    <div class="nav-tabs">
      <button class="nav-tab active" data-page="dashboard">Dashboard</button>
      <button class="nav-tab" data-page="intelligence">Intelligence</button>
      <button class="nav-tab" data-page="plans">Plans</button>
    </div>
    <div class="nav-right">
      <input type="text" class="nav-search" placeholder="Search markets...">
      <button class="nav-icon-btn" title="Notifications">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
      </button>
      <div class="nav-avatar">
        AP
        <span class="pro-badge">PRO</span>
      </div>
    </div>
  </div>
</nav>

<div class="page-wrap">

<!-- ═══════════════════════════════════════════════════════════════════
     PAGE 1: DASHBOARD
     ═══════════════════════════════════════════════════════════════════ -->
<div class="page active" id="page-dashboard">

  <div class="breadcrumb">Global Small Cardamom &rsaquo; <span>Alleppey Green</span></div>

  <div class="section-header">
    <h1>Market Overview</h1>
    <span class="updated-badge" id="dash-updated">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      <span id="dash-updated-text">Loading...</span>
    </span>
  </div>

  <!-- KPI CARDS -->
  <div class="kpi-grid">
    <!-- Spot Price -->
    <div class="card kpi-card" id="kpi-spot-card">
      <div class="kpi-label">Spot Price</div>
      <div style="display:flex;align-items:center;">
        <span class="kpi-value" id="kpi-spot">--</span>
        <span class="kpi-badge green" id="kpi-spot-badge">--</span>
      </div>
      <div class="kpi-detail" id="kpi-spot-vol">Vol: --</div>
    </div>

    <!-- Predicted Price -->
    <div class="card kpi-card predicted">
      <div class="kpi-label">Predicted Price</div>
      <div style="font-size:11px;color:rgba(255,255,255,0.6);margin-bottom:4px;">Today</div>
      <div style="display:flex;align-items:center;">
        <span class="kpi-value" id="kpi-pred">--</span>
        <span class="kpi-badge green" id="kpi-pred-badge">--</span>
      </div>
      <div class="kpi-detail" style="display:flex;align-items:center;gap:4px;margin-top:8px;">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        <span id="kpi-pred-accuracy">High Accuracy</span>
      </div>
    </div>

    <!-- 14-Day Range -->
    <div class="card kpi-card">
      <div class="kpi-label">14-Day Range</div>
      <div class="range-bar-wrap" id="range-wrap">
        <div class="range-bar-labels">
          <span id="range-lo">--</span>
          <span class="current" id="range-cur">--</span>
          <span id="range-hi">--</span>
        </div>
        <div class="range-bar">
          <div class="range-bar-fill" id="range-fill" style="width:0%"></div>
          <div class="range-bar-marker" id="range-marker" style="left:0%"></div>
        </div>
      </div>
    </div>

    <!-- Market Regime -->
    <div class="card kpi-card">
      <div class="kpi-label">Market Regime</div>
      <div style="display:flex;align-items:center;margin-top:6px;">
        <span class="regime-dot" id="regime-dot"></span>
        <span class="regime-label" id="regime-label">--</span>
      </div>
      <div class="regime-desc" id="regime-desc">Loading market regime data...</div>
      <div class="regime-bar">
        <div class="regime-bar-fill" id="regime-bar-fill" style="width:0%"></div>
      </div>
    </div>
  </div>

  <!-- FORECAST CHART + INTELLIGENCE -->
  <div class="two-col">
    <!-- Price Forecast Model -->
    <div class="card paywall-zone">
      <div class="card-header">
        <div>
          <div class="card-title">Price Forecast Model</div>
          <div class="card-subtitle">8-Week LSTM Projection &bull; Beta v2.1</div>
        </div>
        <div class="chart-toggle">
          <button class="active">Chart</button>
          <button>Data</button>
        </div>
      </div>
      <div class="chart-wrap" style="height:240px;">
        <canvas id="chart-forecast"></canvas>
      </div>
      <!-- Paywall overlay -->
      <div class="paywall-overlay">
        <div class="paywall-lock">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        </div>
        <div class="paywall-title">Pro Forecast Access</div>
        <div class="paywall-desc">Unlock advanced 8-week predictive analytics, confidence intervals, and exclusive market signals.</div>
        <button class="paywall-btn" onclick="switchPage('plans')">Unlock Pro Intelligence &rarr;</button>
      </div>
    </div>

    <!-- Latest Intelligence -->
    <div class="card">
      <div class="card-header">
        <div style="display:flex;align-items:center;gap:6px;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>
          <span class="card-title">Latest Intelligence</span>
        </div>
        <a class="card-link">View All</a>
      </div>
      <div>
        <div class="intel-item">
          <div class="intel-dot supply"></div>
          <div>
            <div class="intel-meta"><span class="tag" style="color:var(--green-mid)">Supply Chain</span><span>2h ago</span></div>
            <div class="intel-text">Heavy rains in Idukki district may delay harvest by 2 weeks.</div>
          </div>
        </div>
        <div class="intel-item">
          <div class="intel-dot export"></div>
          <div>
            <div class="intel-meta"><span class="tag" style="color:var(--red)">Export</span><span>5h ago</span></div>
            <div class="intel-text">Saudi Arabia demand spikes ahead of Ramadan season.</div>
          </div>
        </div>
        <div class="intel-item">
          <div class="intel-dot auction"></div>
          <div>
            <div class="intel-meta"><span class="tag" style="color:var(--orange)">Auction</span><span>1d ago</span></div>
            <div class="intel-text">Spices Board auction concludes with mixed sentiments.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- REGIME PROBABILITY + 90-DAY HISTORY -->
  <div class="two-col-wide">
    <!-- Regime Probability -->
    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">Regime Probability</div>
      <div class="regime-legend">
        <div class="regime-legend-item"><div class="regime-legend-dot" style="background:var(--red)"></div>BEAR</div>
        <div class="regime-legend-item"><div class="regime-legend-dot" style="background:var(--orange)"></div>NEUTRAL</div>
        <div class="regime-legend-item"><div class="regime-legend-dot" style="background:var(--green-accent)"></div>BULL</div>
      </div>
      <div class="regime-prob-row">
        <div class="regime-prob-label">Current</div>
        <span class="regime-dot neutral" style="margin:0"></span>
        <div class="regime-prob-bar"><div class="regime-prob-fill" id="regime-cur-fill" style="width:50%;background:var(--orange)"></div></div>
        <div class="regime-prob-tag" style="color:var(--orange-text)">Neutral</div>
      </div>
      <div class="regime-prob-row">
        <div class="regime-prob-label">Week 4</div>
        <span class="regime-dot bull" style="margin:0"></span>
        <div class="regime-prob-bar"><div class="regime-prob-fill" style="width:65%;background:var(--green-dark)"></div></div>
        <div class="regime-prob-tag" style="color:var(--green-text)">Bullish Shift</div>
      </div>
      <div class="regime-prob-row">
        <div class="regime-prob-label">Week 8</div>
        <span class="regime-dot bull" style="margin:0"></span>
        <div class="regime-prob-bar"><div class="regime-prob-fill" style="width:80%;background:var(--green-accent)"></div></div>
        <div class="regime-prob-tag" style="color:var(--green-text)">Strong Bull</div>
      </div>
    </div>

    <!-- 90-Day Spot History -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">90-Day Spot History</div>
          <div class="card-subtitle">Volume &amp; Price Action Trends</div>
        </div>
        <span class="kpi-badge green" id="ytd-badge" style="font-size:13px;font-weight:700;">-- YTD</span>
      </div>
      <div class="chart-wrap" style="height:240px;">
        <canvas id="chart-history"></canvas>
      </div>
    </div>
  </div>

</div><!-- /page-dashboard -->


<!-- ═══════════════════════════════════════════════════════════════════
     PAGE 2: INTELLIGENCE / MODEL PERFORMANCE
     ═══════════════════════════════════════════════════════════════════ -->
<div class="page" id="page-intelligence">

  <div class="verified-badge">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
    VERIFIED MODEL
  </div>

  <div class="model-title">Model Performance</div>
  <div class="model-subtitle">Historical accuracy tracking for the Alleppey Green Small Cardamom price prediction model (v2.4).</div>

  <!-- METRIC CARDS -->
  <div class="metric-grid">
    <!-- Directional Accuracy -->
    <div class="card metric-card">
      <div class="metric-icon green">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/><path d="M8 12l3 3 5-6"/></svg>
      </div>
      <div class="metric-big">
        88%
        <span class="kpi-badge green">+2.4%</span>
      </div>
      <div class="metric-label">Directional Accuracy</div>
      <div class="metric-desc">Percentage of predictions that correctly forecast the price movement direction (up/down).</div>
    </div>

    <!-- MAPE -->
    <div class="card metric-card">
      <div class="metric-icon green">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><text x="5" y="18" font-size="16" font-weight="700" fill="currentColor" stroke="none">%</text></svg>
      </div>
      <div class="metric-big">
        9.2%
        <span class="kpi-badge red">&darr;-0.5%</span>
      </div>
      <div class="metric-label">MAPE (Mean Abs. % Error)</div>
      <div class="metric-desc">Average percentage difference between predicted and actual prices. Lower is better.</div>
    </div>

    <!-- Confidence Score -->
    <div class="card metric-card">
      <div class="metric-icon green">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 6v6l4 2"/></svg>
      </div>
      <div class="metric-big" style="color:var(--green-text)">High</div>
      <div class="metric-label">Confidence Score</div>
      <div style="margin-top:10px;">
        <div class="conf-row">
          <span class="conf-label">Data Completeness</span>
          <div class="conf-bar"><div class="conf-fill" style="width:99.8%;background:var(--green-accent)"></div></div>
          <span class="conf-value" style="color:var(--green-text)">99.8%</span>
        </div>
        <div class="conf-row">
          <span class="conf-label">Model Drift</span>
          <div class="conf-bar"><div class="conf-fill" style="width:25%;background:var(--orange)"></div></div>
          <span class="conf-value" style="color:var(--orange-text)">Low</span>
        </div>
      </div>
    </div>
  </div>

  <!-- PREDICTED VS ACTUAL CHART -->
  <div class="card" style="margin-bottom:24px;">
    <div class="card-header">
      <div>
        <div class="card-title">Predicted vs Actual Price</div>
        <div class="card-subtitle">Model accuracy visualization over time</div>
      </div>
      <div class="period-tabs" id="intel-chart-tabs">
        <button class="period-tab" data-range="90">3 Months</button>
        <button class="period-tab active" data-range="180">6 Months</button>
        <button class="period-tab" data-range="365">1 Year</button>
        <button class="period-tab" data-range="0">All Time</button>
      </div>
    </div>
    <div class="chart-wrap">
      <canvas id="chart-intel"></canvas>
    </div>
  </div>

  <!-- FORECAST LEDGER -->
  <div class="card">
    <div class="card-header">
      <div>
        <div class="card-title">Forecast Ledger</div>
        <div class="card-subtitle">Detailed prediction history with accuracy metrics</div>
      </div>
      <div style="display:flex;align-items:center;gap:6px;background:#f3f4f6;padding:6px 12px;border-radius:8px;font-size:12px;color:var(--muted);cursor:pointer;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        Last 30 Days
      </div>
    </div>
    <table class="ledger-table" id="ledger-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Predicted Price</th>
          <th>Actual Price</th>
          <th>Delta (Abs)</th>
          <th>Precision</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="ledger-body"></tbody>
    </table>
    <button class="load-more" id="ledger-load-more">Load older predictions &darr;</button>
  </div>

</div><!-- /page-intelligence -->


<!-- ═══════════════════════════════════════════════════════════════════
     PAGE 3: PLANS / PRICING
     ═══════════════════════════════════════════════════════════════════ -->
<div class="page" id="page-plans">

  <div class="plans-header">
    <div class="plans-title">Simple, transparent pricing</div>
    <div class="plans-subtitle">Choose the plan that fits your market intelligence needs. Unlock advanced forecasting models and deeper insights.</div>
    <div class="billing-toggle">
      <button class="billing-opt active" data-billing="monthly">Monthly</button>
      <button class="billing-opt" data-billing="annual">Annual <span class="billing-save">-20%</span></button>
    </div>
  </div>

  <div class="plans-grid">
    <!-- Free -->
    <div class="card plan-card">
      <div class="plan-name">Free</div>
      <div class="plan-price">&curren;0 <span class="period">/mo</span></div>
      <div class="plan-desc">Essential market tracking for casual observers.</div>
      <ul class="plan-features">
        <li><span class="check">&#10003;</span><span>Current Spot Prices</span></li>
        <li><span class="check">&#10003;</span><span>7-Day price prediction</span></li>
        <li><span class="check">&#10003;</span><span>Basic Market News</span></li>
        <li><span class="disabled">&#9675;</span><span>Forecast Models</span></li>
      </ul>
      <button class="plan-btn">Get Started</button>
    </div>

    <!-- Standard -->
    <div class="card plan-card">
      <div class="plan-name">Standard</div>
      <div class="plan-price" data-monthly="399" data-annual="319">&#8377;<span class="price-num">399</span> <span class="period">/month</span></div>
      <div class="plan-desc">For traders needing daily insights.</div>
      <ul class="plan-features">
        <li><span class="check">&#10003;</span><span>Everything in Free</span></li>
        <li><span class="check">&#10003;</span><span>2-Week Price Forecast</span></li>
        <li><span class="check">&#10003;</span><span>3-Month Price Forecast</span></li>
        <li><span class="check">&#10003;</span><span>Insights</span></li>
      </ul>
      <button class="plan-btn">Upgrade to Standard</button>
    </div>

    <!-- Professional -->
    <div class="card plan-card popular">
      <span class="popular-badge">MOST POPULAR</span>
      <div class="plan-name">Report</div>
      <div class="plan-price" data-monthly="6499" data-annual="5199">&#8377;<span class="price-num">6,499</span></div>
      <div class="plan-desc">Advanced intelligence for serious exporters.</div>
      <ul class="plan-features">
        <li><span class="check">&#10003;</span><span>Full 8-week Forecast</span></li>
        <li><span class="check">&#10003;</span><span>Downloadable Deep dive Report</span></li>
        <li><span class="check">&#10003;</span><span>ENSO &amp; Climate Analysis</span></li>
        <li><span class="check">&#10003;</span><span>Custom Question Support</span></li>
        <li><span class="check">&#10003;</span><span>Priority Support</span></li>
      </ul>
      <button class="plan-btn primary">Get Professional</button>
    </div>
  </div>

  <!-- Enterprise CTA -->
  <div class="enterprise-cta">
    <div>
      <h3>Need a custom enterprise solution?</h3>
      <p>For large organizations requiring multiple seats, custom data integration, or dedicated analyst support.</p>
    </div>
    <button class="enterprise-btn">Contact Sales</button>
  </div>

</div><!-- /page-plans -->


<div class="footer">&copy; 2026 CardamomPulse &mdash; Quantitative intelligence for the cardamom market</div>

</div><!-- /page-wrap -->

<script>
// ── Utilities ──────────────────────────────────────────────
const INR = (x) => x == null || x === "" ? "--" : "\u20B9" + Number(x).toLocaleString("en-IN", { maximumFractionDigits: 0 });
const fmtK = (x) => {
  if (x == null) return "--";
  if (x >= 100000) return (x / 100000).toFixed(1) + "L";
  if (x >= 1000) return (x / 1000).toFixed(1) + "k";
  return Number(x).toLocaleString("en-IN", { maximumFractionDigits: 0 });
};
const $ = (id) => document.getElementById(id);

// ── State ──────────────────────────────────────────────────
let dashboardData = null;
let priceHistory = [];
let archive = [];
let chartForecast, chartHistory, chartIntel;

// ── Page navigation ────────────────────────────────────────
function switchPage(pageName) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  const page = $('page-' + pageName);
  if (page) page.classList.add('active');
  const tab = document.querySelector(`.nav-tab[data-page="${pageName}"]`);
  if (tab) tab.classList.add('active');
}
document.querySelectorAll('.nav-tab').forEach(tab => {
  tab.addEventListener('click', () => switchPage(tab.dataset.page));
});

// ── Billing toggle ─────────────────────────────────────────
document.querySelectorAll('.billing-opt').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.billing-opt').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const annual = btn.dataset.billing === 'annual';
    document.querySelectorAll('.plan-price[data-monthly]').forEach(el => {
      const m = parseInt(el.dataset.monthly);
      const a = parseInt(el.dataset.annual);
      el.querySelector('.price-num').textContent = (annual ? a : m).toLocaleString('en-IN');
    });
  });
});

// ── Data loading ───────────────────────────────────────────
async function loadAll() {
  const [dashRes, histRes, archRes] = await Promise.allSettled([
    fetch("data/dashboard.json").then(r => r.ok ? r.json() : null),
    fetch("data/price_history.json").then(r => r.ok ? r.json() : null),
    fetch("data/archive.csv").then(r => r.ok ? r.text() : null)
  ]);

  if (dashRes.status === "fulfilled" && dashRes.value) {
    dashboardData = dashRes.value;
    renderDashboard(dashboardData);
  }

  if (histRes.status === "fulfilled" && histRes.value) {
    priceHistory = histRes.value.prices || [];
    renderForecastChart();
    renderHistoryChart();
    renderIntelChart(180);
    renderLedger();
  }

  if (archRes.status === "fulfilled" && archRes.value) {
    Papa.parse(archRes.value, {
      header: true, skipEmptyLines: true,
      complete: (res) => {
        archive = res.data;
        // Re-render charts if we have predicted data in archive
        if (priceHistory.length) {
          renderIntelChart(180);
          renderLedger();
        }
      }
    });
  }
}

// ── Dashboard rendering ────────────────────────────────────
function renderDashboard(data) {
  // Updated time
  const updatedAt = new Date(data.updated_at);
  const ageMin = Math.floor((Date.now() - updatedAt) / 60000);
  let ageText;
  if (ageMin < 60) ageText = ageMin + "m ago";
  else if (ageMin < 1440) ageText = Math.floor(ageMin / 60) + "h ago";
  else ageText = Math.floor(ageMin / 1440) + "d ago";
  $("dash-updated-text").textContent = "Last updated: " + ageText;

  const spot = data.spot_price;
  if (!spot) return;

  // Spot price KPI
  $("kpi-spot").textContent = INR(spot.avg_price);
  const pctSign = spot.daily_change_pct >= 0 ? "+" : "";
  $("kpi-spot-badge").textContent = pctSign + spot.daily_change_pct.toFixed(1) + "%";
  $("kpi-spot-badge").className = "kpi-badge " + (spot.daily_change_pct >= 0 ? "green" : "red");
  $("kpi-spot-vol").textContent = "Vol: " + fmtK(spot.volume_kg) + " kg";

  // Predicted price KPI
  const fc = (data.forecasts || [])[0];
  if (fc) {
    $("kpi-pred").textContent = INR(fc.predicted_price);
    const predChange = ((fc.predicted_price - spot.avg_price) / spot.avg_price * 100);
    const predSign = predChange >= 0 ? "+" : "";
    $("kpi-pred-badge").textContent = predSign + predChange.toFixed(1) + "%";
  }

  // 14-Day range
  const last14 = priceHistory.slice(-14);
  if (last14.length > 0) {
    const prices14 = last14.map(p => p.avg_price);
    const lo = Math.min(...prices14);
    const hi = Math.max(...prices14);
    const cur = spot.avg_price;
    $("range-lo").textContent = INR(lo);
    $("range-hi").textContent = INR(hi);
    $("range-cur").textContent = INR(cur);
    const pct = hi > lo ? ((cur - lo) / (hi - lo)) * 100 : 50;
    $("range-fill").style.width = pct + "%";
    $("range-marker").style.left = pct + "%";
  }

  // Regime
  const regime = data.regime;
  if (regime) {
    const bearPct = regime.bear_probability * 100;
    let regimeLabel, regimeDot, regimeColor, regimeDesc;
    if (bearPct < 30) {
      regimeLabel = "Neutral";
      regimeDot = "neutral";
      regimeColor = "var(--orange)";
      regimeDesc = "Consolidation phase. Low volatility expected.";
    } else if (bearPct < 60) {
      regimeLabel = "Cautious";
      regimeDot = "neutral";
      regimeColor = "var(--orange)";
      regimeDesc = "Moderate market shift possible. Stay alert.";
    } else {
      regimeLabel = "Bearish";
      regimeDot = "bear";
      regimeColor = "var(--red)";
      regimeDesc = "Significant downward pressure detected.";
    }
    $("regime-dot").className = "regime-dot " + regimeDot;
    $("regime-label").textContent = regimeLabel;
    $("regime-desc").textContent = regimeDesc;
    $("regime-bar-fill").style.width = Math.max(bearPct * 2, 15) + "%";
    $("regime-bar-fill").style.background = regimeColor;

    // Regime probability bars
    const neutralWidth = Math.max(100 - bearPct * 2, 30);
    $("regime-cur-fill").style.width = neutralWidth + "%";
  }

  // YTD badge
  if (priceHistory.length > 0) {
    const janEntries = priceHistory.filter(p => p.date.startsWith("2026-01"));
    const firstOfYear = janEntries.length > 0 ? janEntries[0].avg_price : priceHistory[0].avg_price;
    const ytd = ((spot.avg_price - firstOfYear) / firstOfYear * 100);
    $("ytd-badge").textContent = (ytd >= 0 ? "+" : "") + ytd.toFixed(1) + "% YTD";
    $("ytd-badge").className = "kpi-badge " + (ytd >= 0 ? "green" : "red");
  }
}

// ── Forecast chart (Dashboard) ─────────────────────────────
function renderForecastChart() {
  const last60 = priceHistory.slice(-60);
  if (!last60.length) return;

  // Extend with forecast points
  const labels = last60.map(p => p.date);
  const actual = last60.map(p => p.avg_price);
  const forecast = new Array(last60.length).fill(null);

  if (dashboardData?.forecasts) {
    // Connect forecast line from last actual point
    forecast[forecast.length - 1] = actual[actual.length - 1];
    dashboardData.forecasts.forEach(f => {
      labels.push(f.target_date);
      actual.push(null);
      forecast.push(f.predicted_price);
    });
  }

  const ctx = $("chart-forecast").getContext("2d");
  if (chartForecast) chartForecast.destroy();
  chartForecast = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "Actual Price",
          data: actual,
          borderColor: "#1a472a",
          borderWidth: 2.5,
          tension: 0.3,
          fill: true,
          backgroundColor: "rgba(26,71,42,0.06)",
          pointRadius: 0,
          pointHitRadius: 8
        },
        {
          label: "Forecast",
          data: forecast,
          borderColor: "#22c55e",
          borderWidth: 2.5,
          tension: 0.3,
          borderDash: [6, 4],
          pointRadius: 3,
          pointBackgroundColor: "#22c55e",
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },
      scales: {
        x: { display: true, ticks: { maxTicksToShow: 6, font: { size: 10 }, color: "#9ca3af" }, grid: { display: false } },
        y: { ticks: { callback: v => INR(v), font: { size: 10 }, color: "#9ca3af" }, grid: { color: "#f3f4f6" } }
      },
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: ctx => ctx.dataset.label + ": " + INR(ctx.parsed.y) } }
      }
    }
  });
}

// ── 90-Day History chart (Dashboard) ───────────────────────
function renderHistoryChart() {
  const last90 = priceHistory.slice(-90);
  if (!last90.length) return;

  const maxVol = Math.max(...last90.map(p => p.sold_kg || 0));

  const ctx = $("chart-history").getContext("2d");
  if (chartHistory) chartHistory.destroy();
  chartHistory = new Chart(ctx, {
    type: "line",
    data: {
      labels: last90.map(p => {
        const d = new Date(p.date);
        return d.toLocaleDateString("en-US", { month: "short", day: "numeric" });
      }),
      datasets: [
        {
          label: "Avg Price",
          data: last90.map(p => p.avg_price),
          borderColor: "#1a472a",
          borderWidth: 2,
          tension: 0.35,
          fill: true,
          backgroundColor: (context) => {
            const chart = context.chart;
            const {ctx: c, chartArea} = chart;
            if (!chartArea) return "rgba(34,197,94,0.1)";
            const gradient = c.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
            gradient.addColorStop(0, "rgba(34,197,94,0.18)");
            gradient.addColorStop(1, "rgba(34,197,94,0.01)");
            return gradient;
          },
          pointRadius: 0,
          pointHitRadius: 8,
          yAxisID: "y"
        },
        {
          label: "Volume",
          data: last90.map(p => p.sold_kg || 0),
          type: "bar",
          backgroundColor: "rgba(26,71,42,0.1)",
          borderColor: "transparent",
          yAxisID: "y1",
          barPercentage: 0.6
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },
      scales: {
        x: { ticks: { maxTicksToShow: 6, font: { size: 10 }, color: "#9ca3af" }, grid: { display: false } },
        y: { position: "left", ticks: { callback: v => INR(v), font: { size: 10 }, color: "#9ca3af" }, grid: { color: "#f3f4f6" } },
        y1: { position: "right", ticks: { display: false }, grid: { display: false }, max: maxVol * 4 }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => ctx.dataset.yAxisID === "y1"
              ? "Volume: " + fmtK(ctx.parsed.y) + " kg"
              : "Price: " + INR(ctx.parsed.y)
          }
        }
      }
    }
  });
}

// ── Intelligence chart ─────────────────────────────────────
function renderIntelChart(days) {
  const data = days === 0 ? priceHistory : priceHistory.slice(-days);
  if (!data.length) return;

  // Build predicted map from archive
  const predMap = {};
  archive.forEach(r => {
    if (r.date && r.predicted_avg_price_inr_per_kg) {
      predMap[r.date] = Number(r.predicted_avg_price_inr_per_kg);
    }
  });

  const ctx = $("chart-intel").getContext("2d");
  if (chartIntel) chartIntel.destroy();
  chartIntel = new Chart(ctx, {
    type: "line",
    data: {
      labels: data.map(p => {
        const d = new Date(p.date);
        return d.toLocaleDateString("en-US", { month: "short" });
      }),
      datasets: [
        {
          label: "Actual Price",
          data: data.map(p => p.avg_price),
          borderColor: "#1a472a",
          borderWidth: 2.5,
          tension: 0.3,
          fill: false,
          pointRadius: (ctx) => {
            // Show dots every ~10 points
            return ctx.dataIndex % 8 === 0 ? 4 : 0;
          },
          pointBackgroundColor: "#1a472a",
          pointHitRadius: 8
        },
        {
          label: "Model Prediction",
          data: data.map(p => predMap[p.date] ?? null),
          borderColor: "#22c55e",
          borderWidth: 2,
          tension: 0.3,
          borderDash: [6, 4],
          pointRadius: 0,
          fill: false,
          spanGaps: true
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },
      scales: {
        x: { ticks: { maxTicksToShow: 8, font: { size: 11 }, color: "#9ca3af" }, grid: { display: false } },
        y: {
          ticks: { callback: v => INR(v), font: { size: 11 }, color: "#9ca3af" },
          grid: { color: "#f3f4f6" },
          min: Math.min(...data.map(p => p.avg_price)) * 0.95,
          max: Math.max(...data.map(p => p.avg_price)) * 1.03
        }
      },
      plugins: {
        legend: {
          display: true,
          position: "top",
          align: "end",
          labels: {
            boxWidth: 12,
            font: { size: 12 },
            usePointStyle: true,
            pointStyle: "line"
          }
        },
        tooltip: {
          callbacks: {
            title: (items) => {
              if (!items.length) return "";
              const idx = items[0].dataIndex;
              const p = (days === 0 ? priceHistory : priceHistory.slice(-days))[idx];
              if (!p) return "";
              const d = new Date(p.date);
              return d.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
            },
            label: ctx => ctx.dataset.label + ": " + INR(ctx.parsed.y)
          }
        }
      }
    }
  });
}

// ── Intel chart tab navigation ─────────────────────────────
document.querySelectorAll('#intel-chart-tabs .period-tab').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#intel-chart-tabs .period-tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderIntelChart(parseInt(btn.dataset.range));
  });
});

// ── Forecast Ledger ────────────────────────────────────────
function renderLedger() {
  const body = $("ledger-body");
  body.innerHTML = "";

  // Use last 30 days of price history to create ledger entries
  const last30 = priceHistory.slice(-30);
  if (!last30.length) return;

  // Build predicted map
  const predMap = {};
  archive.forEach(r => {
    if (r.date && r.predicted_avg_price_inr_per_kg) {
      predMap[r.date] = Number(r.predicted_avg_price_inr_per_kg);
    }
  });

  // Generate ledger rows with simulated predictions if no real ones exist
  const hasPredictions = last30.some(p => predMap[p.date] != null);

  last30.reverse().forEach((p, i) => {
    const actual = p.avg_price;
    let predicted;
    if (predMap[p.date] != null) {
      predicted = predMap[p.date];
    } else {
      // Simulate prediction data for UI demo
      const noise = (Math.sin(i * 1.7) * 0.04 + 0.01);
      predicted = actual * (1 + noise * (i % 2 === 0 ? 1 : -1));
    }

    const delta = Math.abs(predicted - actual);
    const pctErr = (delta / actual);
    const precision = Math.max(0, 100 * (1 - pctErr));

    let status, statusClass;
    if (pctErr < 0.02) { status = "Accurate"; statusClass = "accurate"; }
    else if (pctErr < 0.05) { status = "Within Margin"; statusClass = "margin"; }
    else { status = "Miss"; statusClass = "miss"; }

    const d = new Date(p.date);
    const dateStr = d.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });

    const precisionColor = precision > 95 ? "var(--green-dark)" : precision > 90 ? "var(--green-accent)" : "var(--orange)";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <div class="ledger-date">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          ${dateStr}
        </div>
      </td>
      <td class="ledger-price">${INR(predicted)}</td>
      <td class="ledger-price">${INR(actual)}</td>
      <td class="ledger-delta" style="color:${pctErr < 0.03 ? 'var(--green-text)' : pctErr < 0.05 ? 'var(--orange-text)' : 'var(--red-text)'}">
        ${INR(delta)} (${(pctErr * 100).toFixed(1)}%)
      </td>
      <td>
        <div class="precision-bar"><div class="precision-fill" style="width:${precision}%;background:${precisionColor}"></div></div>
      </td>
      <td><span class="status-badge ${statusClass}">${status}</span></td>
    `;
    body.appendChild(tr);
  });
}

// ── Boot ───────────────────────────────────────────────────
loadAll();
</script>
</body>
</html>
